## 一、Kafka 的整体结构

> **Kafka 是一个由多个 broker 组成的集群，
> topic 被拆成 partition，
> 每个 partition 在多个 broker 上以 replica 的形式存在。**

---

## 二、Broker 是什么角色？

**Broker = Kafka 集群中的一个节点（一台机器 / 一个进程）**

它负责：

* 存储数据（分区日志）
* 接收 producer 写入
* 响应 consumer 读取
* 作为某些 partition 的 **leader 或 follower**

一个集群里：

```
Broker 1
Broker 2
Broker 3
...
```

---

## 三、Topic 的结构

**Topic 不是存数据的实体，它是一个逻辑概念**

```
Topic: orders
```

真正存数据的是 **partition**。

---

## 四、Partition（真正的存储单元）

每个 topic 会被拆成多个 partition：

```
Topic: orders
├─ Partition_0
├─ Partition_1
├─ Partition_2
```

特点：

* 每个 partition 是 **有序的**
* partition 之间 **无序**
* 一个 partition 在同一时刻 **只有一个 leader**

---

## 五、Replica（高可用的关键）

每个 partition 会有多个副本（replica）：

```
Partition_0
├─ Replica on Broker 1 (Leader)
├─ Replica on Broker 2 (Follower)
├─ Replica on Broker 3 (Follower)
...
```

规则：

* **Leader 处理所有读写**
* Follower 只负责 **同步数据**
* Leader 挂了 → 从 ISR 中选新 Leader

---

## 六、Broker、Partition、Replica 的关系图

```
Kafka Cluster
│
├─ Broker 1
│   ├─ orders-Partition_0 (Leader)
│   └─ orders-Partition_1 (Follower)
│
├─ Broker 2
│   ├─ orders-Partition_1 (Leader)
│   └─ orders-Partition_2 (Follower)
│
├─ Broker 3
│   ├─ orders-Partition_2 (Leader)
│   └─ orders-Partition_0 (Follower)
...
```

可以看出：

* 一个 broker 上会有 **多个 topic 的多个 partition**
* 同一个 partition 的 replica 分布在不同 broker 上
* leader 分散，避免热点

---

## 七、Consumer Group 和 Partition 的关系

```
Consumer Group A
├─ Consumer 1 → Partition 0
├─ Consumer 2 → Partition 1
├─ Consumer 3 → Partition 2
```

规则：

* **一个 partition 在一个 group 内只会被一个 consumer 消费**
* consumer 数量 ≤ partition 数量

---

## 八、总结

> Kafka 集群由多个 broker 组成；
> topic 是逻辑概念；
> topic 被拆成多个 partition；
> 每个 partition 在不同 broker 上有多个 replica；
> 其中一个 replica 是 leader，负责读写，其余是 follower 用于容灾。