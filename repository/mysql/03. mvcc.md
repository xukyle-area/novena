# MySQL MVCC (Multi-Version Concurrency Control)

This note describes how MVCC works in MySQL (InnoDB) and how it enables non-blocking reads while maintaining transactional consistency.

## 1. Why MVCC exists

- Avoid read locks for consistent queries.
- Allow reads and writes to proceed concurrently.
- Provide different isolation levels by controlling which versions are visible.

## 2. Core components

### 2.1 Hidden columns in InnoDB

Each row stores extra metadata (not visible in SQL):

- `DB_TRX_ID`: last transaction ID that modified the row.
- `DB_ROLL_PTR`: pointer to the undo log record for the previous version.
- `DB_ROW_ID`: internal row id for tables without a primary key.

### 2.2 Undo log

Undo records store previous versions of a row. InnoDB uses the undo chain to reconstruct older snapshots for consistent reads.

### 2.3 Read View

A Read View is a snapshot describing which transaction IDs are visible for a consistent read. It contains:

- `m_ids`: active transaction IDs at the time the view is created.
- `min_trx_id`: smallest active transaction ID in `m_ids`.
- `max_trx_id`: next transaction ID to be assigned (upper boundary).
- `creator_trx_id`: transaction ID of the current transaction.

## 3. Visibility rules (snapshot read)

Given a row version with `DB_TRX_ID = trx_id`, it is visible if:

1. `trx_id == creator_trx_id` (your own changes).
2. `trx_id < min_trx_id` (committed before the snapshot).
3. `trx_id >= max_trx_id` (created after the snapshot) -> not visible.
4. `trx_id` in `m_ids` (active when snapshot created) -> not visible.
5. Otherwise, visible (committed after snapshot creation but before the view boundary).

If not visible, InnoDB follows `DB_ROLL_PTR` through the undo log to find an older version that matches the rules.

## 4. Isolation levels and MVCC

### 4.1 REPEATABLE READ (default)

- A Read View is created on the first consistent read in the transaction.
- Subsequent consistent reads reuse the same view.
- Gives a stable snapshot for the whole transaction.

### 4.2 READ COMMITTED

- A new Read View is created for each statement.
- Each consistent read sees the latest committed data at the statement start.

### 4.3 SERIALIZABLE

- MVCC is largely bypassed for plain selects.
- `SELECT` behaves like `SELECT ... LOCK IN SHARE MODE`.

### 4.4 READ UNCOMMITTED

- Does not use MVCC snapshot read.
- Can read uncommitted changes (dirty reads).

## 5. Snapshot read vs current read

### 5.1 Snapshot read (consistent read)

- Normal `SELECT` (without locking).
- Uses Read View and undo to return a historical version.

### 5.2 Current read (locking read)

- `SELECT ... FOR UPDATE`
- `SELECT ... LOCK IN SHARE MODE`
- `UPDATE`, `DELETE`, `INSERT`

Current reads always see the latest committed version (and their own uncommitted changes) and may lock rows to prevent conflicts.

## 6. Example timeline

Assume `T1` starts and performs a snapshot read, then `T2` updates a row and commits:

1. `T1` starts.
2. `T1` runs `SELECT` -> Read View is created.
3. `T2` updates row `r` and commits.
4. `T1` runs `SELECT` again -> still sees old version (REPEATABLE READ).
5. `T1` runs `SELECT ... FOR UPDATE` -> sees latest version (current read).

In READ COMMITTED, step 4 would see the new version.

## 7. Phantom reads and next-key locks

Under REPEATABLE READ, InnoDB prevents phantom reads for current reads using next-key locks (record lock + gap lock). Snapshot reads can still see consistent historical results without locking.

## 8. Common misconceptions

- MVCC does not eliminate locks. Writes still need row locks.
- MVCC consistency applies to snapshot reads, not to current reads.
- A row may have multiple historical versions in undo logs; visibility rules choose which one to show.

## 9. Practical tips

- Long transactions keep old versions alive, increasing undo usage.
- Avoid mixing heavy analytics and long updates in the same transaction.
- Use READ COMMITTED when you prefer fresher reads and can tolerate non-repeatable reads.

## 10. Minimal mental model

MVCC = current row + undo chain + read view. Snapshot reads follow the undo chain until a version matches the read view.
