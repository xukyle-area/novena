## 一、结论

> 状态机用于**把业务流程的“状态 + 事件 + 转移规则”显式化**，保证流程合法、降低分支复杂度、提升可维护性和可测试性。

---

## 二、状态机是什么（核心概念）

状态机 = **有限状态集合 + 事件驱动 + 转移规则**

* **State（状态）**：对象当前所处阶段
* **Event（事件）**：触发状态改变的动作
* **Transition（转移）**：状态从 A → B 的规则
* **Guard（条件）**：是否允许转移
* **Action（动作）**：转移时的副作用（扣款、发券、通知等）

典型例子（订单）：

```
CREATED --(PAY)--> PAID --(DELIVER)--> SHIPPED --(CONFIRM)--> DONE
```

---

## 三、状态机的作用

1. **显式约束流程合法性**
	* 非法事件直接拒绝（如未支付不能发货）
2. **降低 if-else 分支爆炸**
	* 用规则替代复杂条件判断
3. **便于测试和回归**
	* 每个事件/状态组合可单测
4. **可观测性更好**
	* 事件流可追踪，状态变更可审计
5. **减少线上事故**
	* 防止越权/重复操作导致的流程紊乱

---

## 四、状态机的特点

* **有限状态**：状态数是可枚举的
* **事件驱动**：状态变化只由事件触发
* **转移可控**：状态切换受规则约束
* **可回放**：事件流可回溯业务过程
* **可持久**：状态可落库，支持恢复

---

## 五、为什么要用状态机

### 1）不使用状态机的常见问题

* 逻辑散落在多个 service、controller
* 无法保证流程合法（越权/跳状态）
* 维护成本高，改一个状态牵扯多个 if-else

### 2）使用状态机的收益

* 规则集中，业务可读性高
* 新增状态/事件影响范围可控
* 能做自动化测试和流程审计

---

## 六、什么时候适合 / 不适合用

### ✅ 适合

* 订单、工单、审批、风控、支付、物流、任务流
* **状态清晰、转移规则稳定**的流程

### ❌ 不适合

* 状态无法枚举、规则经常变化
* 只是简单的 CRUD 状态字段
* 业务强依赖外部系统、逻辑非事件驱动

---

## 七、常见设计要点

1. **状态变更必须幂等**
	* 同一事件重复投递必须可处理
2. **状态落库 + 版本号控制并发**
	* 使用 `version` 或 CAS 防并发错乱
3. **事件需要可追踪**
	* 事件记录 + 请求幂等 ID
4. **动作和转移解耦**
	* 转移规则 ≠ 业务副作用
5. **超时和补偿**
	* 提供超时事件（Timeout）和补偿事件（Cancel）

---

## 八、状态机 vs 状态模式

| 维度     | 状态机             | 状态模式（设计模式）  |
| -------- | ------------------ | --------------------- |
| 本质     | 流程规则模型       | 面向对象的状态封装    |
| 关注点   | 事件驱动的转移规则 | 不同状态下的行为变化  |
| 典型场景 | 审批流、订单流     | UI 或对象内部行为切换 |

---

## 九、COLA / 阿里 / Spring 状态机区别与选型

> 下面按“**工程常见维度**”对比，具体实现以你团队使用的版本为准。

### 1）COLA StateMachine（阿里 COLA ）

* **定位**：轻量、代码优先、适配 DDD
* **优点**：上手快、代码清晰、依赖轻
* **局限**：复杂层级 / 并行状态支持弱，持久化需要自己做
* **适合**：中小流程、事件简单、追求轻量架构

### 2）Spring StateMachine

* **定位**：通用型企业状态机
* **优点**：支持分层状态、并行状态、Guard/Action/Listener 丰富
* **局限**：配置偏重，学习成本高，性能开销更大
* **适合**：流程复杂、需要持久化或高级能力（监听、扩展点）

### 选型建议

1. **简单流程 → COLA**
2. **复杂流程（层级/并行/持久化） → Spring StateMachine**
3. **流程经常变化，需要配置化 → 阿里系/平台化状态机**

---

## 十、常见追问

### Q1：状态机里如何保证并发一致性？

* 状态表加版本号（乐观锁）
* 事件幂等（请求 ID）
* CAS 或数据库事务保证状态原子变更

### Q2：状态机如何做灰度 / 回滚？

* 事件流 + 状态日志可回放
* 允许“补偿事件”而不是强行回滚状态

### Q3：状态机如何和消息队列配合？

* 事件即消息
* 保证消息幂等 + 顺序（同业务主键）

### Q4：状态机配置存在哪里？

* 简单场景：代码内枚举
* 复杂场景：配置中心 / 数据库 / DSL

---

## 十一、总结

> 状态机的价值是把复杂流程“显式化 + 可约束 + 可测试”，选型核心看**流程复杂度、是否需要持久化/可视化、以及团队成本**。
