## 一、结论

> **当外部行情与本交易所价格偏差过大时，优先级是：
> 保护系统与资金安全 ＞ 公平性 ＞ 连续交易体验**

**不要纠结“是不是显得不专业”**，真出事了，穿仓、对敲、被套利，后果更难看。

---

## 二、先定义什么叫“偏差过大”

不能拍脑袋，必须**量化**。

常见做法是 **多维条件触发**，不是单点：

### 1️⃣ 价格偏差阈值

```
|P_internal - P_external| / P_external > X%
```

* 现货：0.5% ~ 1%
* 合约 / 永续：0.3% ~ 0.8%（更严）

---

### 2️⃣ 持续时间

```
偏差持续 > N 秒
```

避免瞬时抖动误杀：

* 3s / 5s / 10s 常见

---

### 3️⃣ 外部行情可信度

不是一个源说了算：

```
外部行情 = 多交易所加权中位数
```

* 剔除极值
* 剔除低流动性源

---

## 三、发现偏差后，可以做什么（从轻到重）

## 🟢 Level 1：限价保护（最温和）

**适合：轻微偏差**

### 做法

* 动态收紧价格限制
* 拒绝“明显偏离外部价格”的订单

例如：

```
买单价格 ≤ 外部价 * 1.01
卖单价格 ≥ 外部价 * 0.99
```

### 目的

* 防止“送钱单”
* 不直接停盘

---

## 🟡 Level 2：撮合降级 / 风控接管

**适合：偏差明显，但行情仍在动**

### 做法

* 禁止市价单
* 禁止大额订单
* 强制只允许限价单
* 或只允许平仓，不允许开仓（合约）

这是很多交易所**真实在用**的方案。

---

## 🟠 Level 3：价格锚定 / 强制修正

**适合：明显被套利 or 行情源异常**

### 做法

* 暂停撮合
* 重新锚定外部价格
* 重建 order book（危险但必要）

⚠️ 风险：

* 必须有审计记录
* 必须对用户公告
* 否则极容易被质疑“人为操纵”

---

## 🔴 Level 4：交易暂停（最重）

**适合：**

* 外部行情异常
* 内部撮合失控
* 已出现穿仓风险

### 做法

* 停止交易
* 只允许撤单
* 等行情恢复

👉 **这是“认怂但保命”的方案**

---

## 四、合约 / 永续场景的特殊处理（非常重要）

你如果在交易所，这一段一定要看。

---

### 1️⃣ 标记价格 vs 最新成交价

**所有风险计算，必须用标记价格（Mark Price）**

```
Mark Price = 外部指数价格 + 平滑因子
```

用途：

* 强平
* 爆仓
* 风险率计算

❌ 绝对不能用 last price
否则必被恶意拉爆

---

### 2️⃣ 偏差过大时，禁止触发强平

极端情况下：

> **宁可延迟强平，也不能用异常价格强平**

否则：

* 用户被“误爆”
* 平台要赔钱 / 背锅

---

## 五、为什么“不处理”是最危险的选择

很多系统一开始是这样想的：

> “市场会自己修复”

现实是：

* 套利机器人 10ms 级别
* 人工 3 秒都嫌慢
* 你不挡 → 就是送钱

尤其是：

* 低流动性币种
* 新币
* 维护窗口

---

## 六、一套可直接落地的策略组合（工程版）

```
if price_deviation > 0.5% for 5s:
    禁止市价单
    限制限价单价格区间

if price_deviation > 1% for 10s:
    暂停开仓
    只允许平仓

if external_price_unavailable or deviation > 2%:
    停止交易
```

并且：

* 全程记录
* 全部可回放
* 可人工 override

---

## 七、总结

> 外部行情和你价格偏差过大时，
> **面对的不是“市场自由”，而是“是否被收割”**。
>
> 该限就限，该停就停，
> 活下来比“看起来专业”重要。