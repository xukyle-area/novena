# Tampines 项目面试准备文档 - 项目概览与架构

## 1. 项目概述

### 1.1 项目简介
**Tampines** 是一个基于 Apache Flink 的**实时金融市场数据处理系统**，主要用于处理订单簿（Order Book）、交易数据（Trade Data）和行情信息（Market Data）。

**核心价值**：
- 实时处理海量市场数据
- 低延迟订单簿维护
- 高性能流式计算
- 支持多交易所数据接入

### 1.2 业务场景
这是一个**金融交易行情系统**，典型应用场景包括：
- 实时维护交易所订单簿（买单/卖单）
- 聚合24小时交易数据生成Ticker行情
- 生成K线（Candle）数据
- 为前端提供实时行情展示
- 支持加密货币交易所（如Crypto.com）数据接入

---

## 2. 系统架构

### 2.1 三层架构设计

```
┌─────────────────────────────────────────────────────────┐
│                   market-outer (外部接口层)                │
│   - WebSocket 数据接入                                     │
│   - Spring Boot 应用                                       │
│   - 数据写入 Redis/Kafka                                   │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼ (Kafka Topics)
┌─────────────────────────────────────────────────────────┐
│               market-flink (流处理核心层)                  │
│   - Order Book 订单簿计算                                  │
│   - Ticker 行情聚合                                        │
│   - Candle K线生成                                         │
│   - Flink State 管理                                       │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼ (Redis)
┌─────────────────────────────────────────────────────────┐
│              market-common (公共基础层)                    │
│   - 数据模型定义                                            │
│   - 工具类和常量                                            │
│   - Redis 客户端                                           │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块详解

#### 📦 market-common (公共模块)
**职责**：提供跨模块的公共组件和数据模型

**主要内容**：
- **model/**：数据模型类
  - `TradeData`：交易数据
  - `Order`：订单数据
  - `OrderBook`：订单簿
  - `CurrencyPair`：交易对
  - `RealTimeQuote`：实时行情
- **redis/**：Redis 客户端封装
- **constants/**：常量定义
- **enums/**：枚举类（Market、Side、Action等）
- **exceptions/**：异常类
- **utils/**：工具类

**关键依赖**：
- Redis Client (Jedis)
- Jackson (JSON序列化)
- Guava (工具库)
- Lombok (代码简化)

---

#### 🔄 market-flink (Flink作业模块)
**职责**：核心流处理逻辑，实现实时数据计算

**主要作业 (Job)**：

##### 1️⃣ OrderbookJob（订单簿作业）
```java
Kafka[order topic] 
  → KeyBy(contractId)
  → OrderBookProcessor (MapState维护买卖盘)
  → OrderBookSink (写入Redis)
```

**核心逻辑**：
- 使用 Flink MapState 维护每个价格档位的数量
- 支持 INSERT/DELETE 操作更新订单簿
- 支持多精度分组（resolution: 1, 5）
- 每秒触发一次输出

**状态管理**：
```java
// 买盘状态
MapState<BigDecimal, BigDecimal> bidState;
// 卖盘状态  
MapState<BigDecimal, BigDecimal> askState;
```

##### 2️⃣ TickerJob（行情聚合作业）
```java
Kafka[trade topic]
  → KeyBy(contractId)
  → Window(滑动窗口 24小时/1秒)
  → TickerAggregator (聚合交易数据)
  → TickerProcessor (生成Ticker)
  → TickerSink (写入Redis)
```

**核心功能**：
- 24小时滑动窗口聚合
- 计算最高价、最低价、成交量等
- 每秒更新一次

##### 3️⃣ CandleJob（K线作业）
- 生成不同时间周期的K线数据（1分钟、5分钟、1小时等）

**关键技术点**：
- Kafka Connector（数据源）
- RocksDB State Backend（状态存储）
- Event Time & Watermark（时间语义）
- KeyedProcessFunction（核心处理逻辑）

---

#### 🌐 market-outer (外部接口模块)
**职责**：数据接入层，负责从外部交易所获取数据

**主要组件**：

**1. WebSocket 客户端**
```java
// Crypto.com 交易所 WebSocket 客户端
CryptoSocketClient extends BaseSocketClient
  - 订阅行情数据
  - 心跳保活
  - 断线重连
```

**2. 数据写入器**
```java
RedisQuoteWriter
  - 将行情数据写入 Redis
  - 提供给前端实时查询
```

**3. Spring Boot 应用**
- 定时任务调度
- 配置管理
- 健康检查

**关键依赖**：
- Spring Boot 2.7.18
- Java-WebSocket
- Redis Client

---

## 3. 数据流转链路

### 3.1 完整数据流

```
外部交易所 (Crypto.com)
    ↓ WebSocket
market-outer (接入层)
    ↓ 
Redis / Kafka Topics
    ↓
market-flink (处理层)
    ├── OrderbookJob → Redis (orderbook:*)
    ├── TickerJob → Redis (ticker:*)
    └── CandleJob → Redis (candle:*)
    ↓
Redis (存储层)
    ↓
前端应用 / API
```

### 3.2 Kafka Topics 设计
推测的 Topic 设计：
- `order` - 订单数据
- `trade` - 交易数据
- `quote` - 行情数据

### 3.3 Redis Key 设计
```
orderbook:{resolution}:{contractId}  # 订单簿
ticker:{contractId}                   # 24小时行情
candle:{period}:{contractId}          # K线数据
```

---

## 4. 核心技术亮点

### 4.1 Flink State 管理
- 使用 **MapState** 高效维护订单簿
- **RocksDB** 作为状态后端，支持大状态存储
- 每个 Contract 独立状态，避免相互影响

### 4.2 精度分组算法
```java
// OrderBookProcessor 中的价格分组
BigDecimal groupedPrice = groupPrice(price, tickSize * resolution);
```
- 将相近价格合并到同一档位
- 支持不同精度展示（resolution: 1, 5, 10, 100）

### 4.3 时间窗口聚合
- 24小时滑动窗口（Window Size = 24h, Slide = 1s）
- 实时更新24小时统计数据

### 4.4 高并发数据接入
- WebSocket 异步接收数据
- 非阻塞写入 Redis/Kafka

---

## 5. 技术栈总结

| 层次           | 技术栈              |
| -------------- | ------------------- |
| **流处理引擎** | Apache Flink 1.17.2 |
| **消息队列**   | Apache Kafka 3.1.2  |
| **缓存/存储**  | Redis (Jedis)       |
| **后端框架**   | Spring Boot 2.7.18  |
| **状态存储**   | RocksDB             |
| **数据格式**   | JSON (Jackson)      |
| **构建工具**   | Maven               |
| **Java版本**   | Java 8              |
| **日志框架**   | Logback + SLF4J     |

---

## 6. 部署架构

### 6.1 组件部署
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Zookeeper  │───▶│    Kafka    │───▶│    Flink    │
│  :2181      │    │   :9092     │    │   :8081     │
└─────────────┘    └─────────────┘    └─────────────┘
                                              │
                                              ▼
┌─────────────┐    ┌─────────────────────────────┐
│    Redis    │◀───│     market-outer (Web)      │
│   :6379     │    │         :10808              │
└─────────────┘    └─────────────────────────────┘
```

### 6.2 启动顺序
1. Zookeeper
2. Kafka
3. Redis
4. Flink Cluster
5. market-flink Jobs (提交到Flink)
6. market-outer (Spring Boot)

---

## 7. 面试要点提炼

### 🎯 当被问到"介绍一下你的项目"时：

**标准回答模板**：
> "我开发了一个基于 Apache Flink 的实时金融市场数据处理系统。这个系统主要解决交易所行情数据的**实时处理和订单簿维护**问题。
> 
> 架构上采用**三层设计**：
> 1. **外部接口层**（market-outer）负责通过 WebSocket 从交易所接入数据
> 2. **流处理核心层**（market-flink）使用 Flink 进行实时计算，包括订单簿维护、行情聚合和K线生成
> 3. **公共基础层**（market-common）提供共享的数据模型和工具类
> 
> 技术栈方面，使用了 **Flink 1.17**、**Kafka 3.1**、**Redis** 作为核心组件，整个系统能够支持**低延迟**的实时数据处理。
>
> 我主要负责的是 **Flink 作业的开发**，其中最核心的是 OrderbookJob，它使用 Flink 的 MapState 来维护每个交易对的买卖盘数据，并通过价格分组算法优化存储和查询效率。"

### 🎯 核心技术难点
1. **如何高效维护订单簿？** → Flink MapState + 价格分组
2. **如何保证数据一致性？** → Keyed State + 精确一次语义
3. **如何处理状态过大问题？** → RocksDB State Backend
4. **如何保证低延迟？** → 异步IO + 内存计算

---

## 8. 项目价值体现

### 8.1 业务价值
- 支持实时行情展示，提升用户体验
- 高精度订单簿维护，支持量化交易
- 多维度数据聚合，支持数据分析

### 8.2 技术价值
- 掌握 Flink 流处理框架
- 理解金融市场微观结构
- 实践大规模实时数据处理架构

### 8.3 可优化方向（面试加分项）
1. 增加数据去重逻辑（DeduplicateProcessor）
2. 支持更多交易所接入
3. 增加监控告警（Flink Metrics）
4. 优化状态存储（Compaction策略）
5. 支持历史数据回放（时间回退）

---

## 9. 快速复习清单

### ✅ 必须记住的关键点
- [ ] 项目名称：Tampines
- [ ] 核心技术：Flink + Kafka + Redis
- [ ] 三个模块：common、flink、outer
- [ ] 三个Job：OrderbookJob、TickerJob、CandleJob
- [ ] 核心状态：MapState（维护订单簿）
- [ ] 数据源：Kafka、数据汇：Redis
- [ ] 端口：Flink 8081、Redis 6379、Kafka 9092、market-outer 10808

### ✅ 核心概念
- **订单簿（OrderBook）**：买卖盘深度数据
- **Ticker**：24小时行情统计
- **Candle**：K线数据
- **Resolution**：价格精度/分组粒度
- **MapState**：Flink键控状态
- **KeyedProcessFunction**：处理函数

### ✅ 数据流方向
外部交易所 → WebSocket → market-outer → Kafka → Flink Jobs → Redis → 前端

---

## 10. 面试常见问题预演

### Q1: 为什么选择 Flink？
**A**: 
1. 原生支持流处理，低延迟
2. 强大的状态管理能力（MapState适合订单簿维护）
3. 精确一次语义保证数据一致性
4. 支持大规模状态存储（RocksDB）
5. 成熟的 Kafka Connector

### Q2: 订单簿如何保证性能？
**A**:
1. 使用 KeyBy 按 contractId 分区，每个交易对独立状态
2. 价格分组算法减少状态数量
3. MapState 内存操作，查询 O(1)
4. RocksDB 异步写入，不阻塞计算

### Q3: 如果订单数据延迟或乱序怎么办？
**A**:
1. 可以引入 Watermark 处理乱序数据
2. 设置合理的允许延迟时间
3. 在 OrderBookProcessor 中已使用 ProcessingTime，避免乱序问题
4. 如需严格顺序，可改用 EventTime + Watermark

### Q4: Redis 挂了怎么办？
**A**:
1. 可以配置 Redis 主从+哨兵模式保证高可用
2. Flink 的 Sink 可以配置失败重试策略
3. 关键数据可以双写（Redis + Kafka）
4. 使用 Flink Checkpoint 保证可恢复