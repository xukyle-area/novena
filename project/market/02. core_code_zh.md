# Tampines é¡¹ç›®é¢è¯•å‡†å¤‡æ–‡æ¡£ - æ ¸å¿ƒä»£ç è§£æ

## 1. OrderBookProcessor æ·±åº¦è§£æ

### 1.1 å®Œæ•´æµç¨‹å›¾
```
è®¢å•æµå…¥ (Order)
    â†“
KeyBy(contractId)  # æŒ‰äº¤æ˜“å¯¹åˆ†ç»„
    â†“
processElement()   # å¤„ç†æ¯æ¡è®¢å•
    â”œâ”€ ä»·æ ¼åˆ†ç»„ (groupPrice)
    â”œâ”€ æ›´æ–° MapState
    â”‚   â”œâ”€ INSERT: å¢åŠ æ•°é‡
    â”‚   â””â”€ DELETE: å‡å°‘/åˆ é™¤
    â””â”€ æ³¨å†Œå®šæ—¶å™¨
    â†“
onTimer() # æ¯ç§’è§¦å‘
    â”œâ”€ éå† bidState/askState
    â”œâ”€ æ„å»º OrderBook å¯¹è±¡
    â””â”€ è¾“å‡ºåˆ°ä¸‹æ¸¸ (Sink)
    â†“
OrderBookSink
    â””â”€ å†™å…¥ Redis
```

### 1.2 æ ¸å¿ƒä»£ç é€è¡Œè§£æ

#### ğŸ“Œ çŠ¶æ€åˆå§‹åŒ–
```java
private MapState<BigDecimal, BigDecimal> bidState;
private MapState<BigDecimal, BigDecimal> askState;

@Override
public void open(Configuration parameters) throws Exception {
    // åˆå§‹åŒ–ä¹°ç›˜çŠ¶æ€ (Key: ä»·æ ¼, Value: æ•°é‡)
    bidState = getRuntimeContext()
            .getMapState(new MapStateDescriptor<>(
                Side.BID.name(), 
                BigDecimal.class, 
                BigDecimal.class));
    
    // åˆå§‹åŒ–å–ç›˜çŠ¶æ€
    askState = getRuntimeContext()
            .getMapState(new MapStateDescriptor<>(
                Side.ASK.name(), 
                BigDecimal.class, 
                BigDecimal.class));
}
```

**é¢è¯•è¦ç‚¹**ï¼š
- `MapState` æ˜¯ Flink æä¾›çš„é”®æ§çŠ¶æ€ç±»å‹
- æ¯ä¸ª Keyï¼ˆcontractIdï¼‰ç»´æŠ¤ç‹¬ç«‹çš„ MapState
- ä½¿ç”¨ `BigDecimal` ä¿è¯é‡‘èè®¡ç®—ç²¾åº¦
- `open()` æ–¹æ³•åœ¨ç®—å­åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡

---

#### ğŸ“Œ è®¢å•å¤„ç†é€»è¾‘
```java
@Override
public void processElement(Order order, Context ctx, Collector<OrderBook> out) 
    throws Exception {
    
    // 1. è·å–åˆçº¦ä¿¡æ¯ï¼Œè®¡ç®—åˆ†ç»„ç²’åº¦
    Contract contract = Contract.getContractById(order.getContractId());
    this.grouping = contract.getTickSize() * resolution;
    
    // 2. é€‰æ‹©ä¹°ç›˜æˆ–å–ç›˜çŠ¶æ€
    MapState<BigDecimal, BigDecimal> sideState = 
        Side.BID.name().equals(order.getSide()) ? bidState : askState;

    // 3. ä»·æ ¼åˆ†ç»„
    BigDecimal price = order.getPrice();
    BigDecimal groupedPrice = this.groupPrice(price, this.grouping);
    BigDecimal quantity = order.getQuantity();
    BigDecimal currentQuantity = sideState.get(groupedPrice);

    // 4. æ ¹æ®æ“ä½œç±»å‹æ›´æ–°çŠ¶æ€
    if (Action.INSERT.name().equals(order.getAction())) {
        // æ–°å¢è®¢å•ï¼šç´¯åŠ æ•°é‡
        BigDecimal newQuantity = 
            currentQuantity != null ? currentQuantity.add(quantity) : quantity;
        sideState.put(groupedPrice, newQuantity);
        
    } else if (Action.DELETE.name().equals(order.getAction())) {
        // åˆ é™¤è®¢å•ï¼šå‡å°‘æ•°é‡
        if (currentQuantity != null) {
            BigDecimal newQuantity = currentQuantity.subtract(quantity);
            if (newQuantity.compareTo(BigDecimal.ZERO) <= 0) {
                sideState.remove(groupedPrice);  // æ•°é‡ä¸º0åˆ™åˆ é™¤
            } else {
                sideState.put(groupedPrice, newQuantity);
            }
        }
    }

    // 5. æ³¨å†Œå®šæ—¶å™¨ï¼Œæ¯ç§’è§¦å‘ä¸€æ¬¡
    long nextTimer = ctx.timerService().currentProcessingTime() / 1000 * 1000 + 1000;
    ctx.timerService().registerProcessingTimeTimer(nextTimer);
}
```

**é¢è¯•è¦ç‚¹**ï¼š
- **ä»·æ ¼åˆ†ç»„**ï¼šå°†ç›¸è¿‘ä»·æ ¼åˆå¹¶ï¼Œå‡å°‘çŠ¶æ€æ•°é‡
- **å¹‚ç­‰æ€§**ï¼šå¤šæ¬¡ INSERT ä¼šç´¯åŠ ï¼Œå¤šæ¬¡ DELETE ä¼šå‡å°‘
- **çŠ¶æ€åˆ é™¤**ï¼šæ•°é‡<=0æ—¶åˆ é™¤ï¼Œé¿å…çŠ¶æ€æ— é™å¢é•¿
- **å®šæ—¶å™¨**ï¼šæ¯ç§’å¯¹é½è§¦å‘ï¼ˆå¦‚ 1000msã€2000msï¼‰ï¼Œé¿å…é¢‘ç¹è¾“å‡º

---

#### ğŸ“Œ å®šæ—¶å™¨è§¦å‘
```java
@Override
public void onTimer(long timestamp, OnTimerContext ctx, Collector<OrderBook> out) 
    throws Exception {
    
    OrderBook orderBook = new OrderBook();

    // 1. éå†ä¹°ç›˜çŠ¶æ€
    for (Map.Entry<BigDecimal, BigDecimal> entry : bidState.entries()) {
        orderBook.getBids().put(entry.getKey(), entry.getValue());
    }
    
    // 2. éå†å–ç›˜çŠ¶æ€
    for (Map.Entry<BigDecimal, BigDecimal> entry : askState.entries()) {
        orderBook.getAsks().put(entry.getKey(), entry.getValue());
    }
    
    // 3. è®¾ç½®å…ƒæ•°æ®
    orderBook.setMarket(Market.GANTEN);
    orderBook.setContractId(ctx.getCurrentKey());  // å½“å‰ Key (contractId)
    orderBook.setGrouping(this.grouping);
    
    // 4. è¾“å‡ºåˆ°ä¸‹æ¸¸
    out.collect(orderBook);
}
```

**é¢è¯•è¦ç‚¹**ï¼š
- æ¯ç§’ç”Ÿæˆä¸€æ¬¡å®Œæ•´è®¢å•ç°¿å¿«ç…§
- `entries()` éå† MapState ä¸­æ‰€æœ‰é”®å€¼å¯¹
- `getCurrentKey()` è·å–å½“å‰å¤„ç†çš„ contractId
- è¾“å‡ºåˆ° `Collector`ï¼Œæµå‘ä¸‹æ¸¸ Sink

---

#### ğŸ“Œ ä»·æ ¼åˆ†ç»„ç®—æ³•
```java
private BigDecimal groupPrice(BigDecimal price, double grouping) {
    // 1. è®¡ç®—ä»·æ ¼å±äºå“ªä¸ªåˆ†ç»„
    // ä¾‹ï¼šprice=100.23, grouping=5
    //     åˆ†ç»„ç¼–å· = floor(100.23 / 5) = 20
    //     åˆ†ç»„ä»·æ ¼ = 20 * 5 = 100.0
    
    BigDecimal groupingBD = BigDecimal.valueOf(grouping);
    return price.divide(groupingBD, 0, RoundingMode.DOWN)
                .multiply(groupingBD);
}
```

**ç¤ºä¾‹è®¡ç®—**ï¼š
```
resolution = 5
tickSize = 0.5
grouping = 5 * 0.5 = 2.5

ä»·æ ¼ 100.1 â†’ åˆ†ç»„ 100.0
ä»·æ ¼ 100.8 â†’ åˆ†ç»„ 100.0
ä»·æ ¼ 102.6 â†’ åˆ†ç»„ 102.5
ä»·æ ¼ 105.0 â†’ åˆ†ç»„ 105.0
```

**é¢è¯•è¦ç‚¹**ï¼š
- `RoundingMode.DOWN`ï¼šå‘ä¸‹å–æ•´
- å‡å°‘ä»·æ ¼æ¡£ä½æ•°é‡ï¼Œé™ä½çŠ¶æ€å­˜å‚¨å‹åŠ›
- ä¸åŒ resolution æä¾›ä¸åŒç²¾åº¦è§†å›¾ï¼ˆå¦‚ 1ã€5ã€10ï¼‰

---

### 1.3 çŠ¶æ€ç®¡ç†å…³é”®é—®é¢˜

#### â“ Q: MapState å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ
**A**: 
- é»˜è®¤å­˜å‚¨åœ¨ **TaskManager çš„å†…å­˜**ä¸­ï¼ˆHeapStateBackendï¼‰
- é…ç½® RocksDB åå­˜å‚¨åœ¨ **æœ¬åœ°ç£ç›˜**ï¼ˆæ›´å¤§å®¹é‡ï¼‰
- é€šè¿‡ Checkpoint æŒä¹…åŒ–åˆ° HDFS/S3 ç­‰å¤–éƒ¨å­˜å‚¨

#### â“ Q: å¦‚ä½•ä¿è¯ä¸åŒ Key çš„çŠ¶æ€éš”ç¦»ï¼Ÿ
**A**: 
- Flink è‡ªåŠ¨æŒ‰ Key åˆ†åŒºï¼Œæ¯ä¸ª Key ç‹¬ç«‹çŠ¶æ€
- `keyBy(Order::getContractId)` åï¼Œä¸åŒ contractId çš„è®¢å•åœ¨ä¸åŒå­ä»»åŠ¡ä¸­å¤„ç†
- çŠ¶æ€è®¿é—®æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å½“å‰ Key çš„ä¸Šä¸‹æ–‡

#### â“ Q: çŠ¶æ€ä¼šæ— é™å¢é•¿å—ï¼Ÿ
**A**:
- æœ¬é¡¹ç›®é€šè¿‡ **åˆ é™¤æ•°é‡ä¸º0çš„ä»·æ ¼æ¡£ä½** æ§åˆ¶å¢é•¿
- å¯ä»¥é…ç½® **State TTL**ï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰è‡ªåŠ¨æ¸…ç†è¿‡æœŸçŠ¶æ€
- ä½¿ç”¨ RocksDB å¢é‡ Checkpoint å‡å°‘å¼€é”€

---

## 2. TickerJob æ·±åº¦è§£æ

### 2.1 æ ¸å¿ƒé€»è¾‘
```java
KeyedStream<Trade, Long> keyedStream = tradeStream.keyBy(Trade::getContractId);

keyedStream
    // 1. å®šä¹‰çª—å£ï¼š24å°æ—¶çª—å£ï¼Œæ¯ç§’æ»‘åŠ¨
    .window(SlidingEventTimeWindows.of(Time.hours(24), Time.seconds(1)))
    
    // 2. èšåˆå‡½æ•°ï¼šç´¯åŠ äº¤æ˜“æ•°æ®
    .aggregate(new TickerAggregator(), new TickerProcessor())
    
    // 3. è¾“å‡ºåˆ° Redis
    .addSink(new TickerSink());
```

### 2.2 æ»‘åŠ¨çª—å£åŸç†

```
æ—¶é—´è½´ï¼š[00:00 ----------- 24:00 ----------- 48:00]

çª—å£1: [00:00 ~ 24:00]  # ç¬¬1ç§’
çª—å£2: [00:01 ~ 24:01]  # ç¬¬2ç§’
çª—å£3: [00:02 ~ 24:02]  # ç¬¬3ç§’
...
```

**ç‰¹ç‚¹**ï¼š
- æ¯ç§’è§¦å‘ä¸€æ¬¡è®¡ç®—
- çª—å£å¤§å° 24 å°æ—¶ï¼Œå§‹ç»ˆç»Ÿè®¡æœ€è¿‘24å°æ—¶æ•°æ®
- è‡ªåŠ¨å‰”é™¤è¶…è¿‡24å°æ—¶çš„æ—§æ•°æ®

### 2.3 èšåˆå‡½æ•°ï¼ˆæ¨æµ‹å®ç°ï¼‰
```java
public class TickerAggregator 
    implements AggregateFunction<Trade, TickerAccumulator, Ticker> {
    
    @Override
    public TickerAccumulator createAccumulator() {
        return new TickerAccumulator();
    }

    @Override
    public TickerAccumulator add(Trade trade, TickerAccumulator acc) {
        // ç´¯åŠ æˆäº¤é‡
        acc.volume += trade.getVolume();
        // æ›´æ–°æœ€é«˜ä»·
        if (trade.getPrice() > acc.high) {
            acc.high = trade.getPrice();
        }
        // æ›´æ–°æœ€ä½ä»·
        if (acc.low == 0 || trade.getPrice() < acc.low) {
            acc.low = trade.getPrice();
        }
        // è®°å½•æœ€æ–°ä»·
        acc.lastPrice = trade.getPrice();
        return acc;
    }

    @Override
    public Ticker getResult(TickerAccumulator acc) {
        Ticker ticker = new Ticker();
        ticker.setVolume(acc.volume);
        ticker.setHigh(acc.high);
        ticker.setLow(acc.low);
        ticker.setLastPrice(acc.lastPrice);
        return ticker;
    }

    @Override
    public TickerAccumulator merge(TickerAccumulator a, TickerAccumulator b) {
        // åˆå¹¶å¤šä¸ªç´¯åŠ å™¨ï¼ˆç”¨äºå¹¶è¡Œè®¡ç®—ï¼‰
        a.volume += b.volume;
        a.high = Math.max(a.high, b.high);
        a.low = Math.min(a.low, b.low);
        return a;
    }
}
```

**é¢è¯•è¦ç‚¹**ï¼š
- `AggregateFunction` æ˜¯å¢é‡èšåˆï¼Œæ€§èƒ½é«˜äºå…¨é‡èšåˆ
- æ¯æ¡æ•°æ®åˆ°è¾¾æ—¶è°ƒç”¨ `add()`ï¼Œæ— éœ€ç¼“å­˜æ‰€æœ‰æ•°æ®
- `merge()` ç”¨äºåˆ†å¸ƒå¼åœºæ™¯ä¸‹åˆå¹¶éƒ¨åˆ†ç»“æœ

---

## 3. Kafka Source é…ç½®è§£æ

### 3.1 KafkaSource æ„å»ºï¼ˆæ¨æµ‹ï¼‰
```java
public class KafkaSourceUtils {
    public static <T> KafkaSource<T> of(InputConfig config, Class<T> clazz) {
        return KafkaSource.<T>builder()
            // Kafka é›†ç¾¤åœ°å€
            .setBootstrapServers(config.getKafkaBootstrapServers())
            
            // è®¢é˜…çš„ Topic
            .setTopics(config.getTopic())
            
            // æ¶ˆè´¹è€…ç»„ ID
            .setGroupId(config.getGroupId())
            
            // èµ·å§‹ä½ç½®ï¼ˆLATEST: æœ€æ–°æ•°æ®, EARLIEST: ä»å¤´å¼€å§‹ï¼‰
            .setStartingOffsets(OffsetsInitializer.latest())
            
            // ååºåˆ—åŒ–å™¨
            .setValueOnlyDeserializer(new JsonDeserializer<>(clazz))
            
            .build();
    }
}
```

### 3.2 å…³é”®é…ç½®é¡¹
```java
public class InputConfig {
    private String kafkaBootstrapServers = "localhost:9092";
    private String topic;
    private String groupId;
    private String checkpointPath;
    private int parallelism = 1;
    
    public static InputConfig build(String topic, String groupId) {
        InputConfig config = new InputConfig();
        config.setTopic(topic);
        config.setGroupId(groupId);
        return config;
    }
}
```

**é¢è¯•è¦ç‚¹**ï¼š
- `topic`: è®¢é˜…çš„ Kafka ä¸»é¢˜ï¼ˆå¦‚ orderã€tradeï¼‰
- `groupId`: æ¶ˆè´¹è€…ç»„ IDï¼Œç”¨äº Offset ç®¡ç†
- `parallelism`: å¹¶è¡Œåº¦ï¼Œæ§åˆ¶èµ„æºä½¿ç”¨

---

## 4. Redis Sink å®ç°

### 4.1 OrderBookSinkï¼ˆæ¨æµ‹å®ç°ï¼‰
```java
public class OrderBookSink extends RichSinkFunction<OrderBook> {
    private transient RedisClient redisClient;

    @Override
    public void open(Configuration parameters) throws Exception {
        // åˆå§‹åŒ– Redis è¿æ¥
        redisClient = RedisClient.getInstance();
    }

    @Override
    public void invoke(OrderBook orderBook, Context context) throws Exception {
        String key = String.format("orderbook:%d:%d", 
            orderBook.getResolution(), 
            orderBook.getContractId());
        
        // åºåˆ—åŒ–ä¸º JSON
        String value = JSON.toJSONString(orderBook);
        
        // å†™å…¥ Redis
        redisClient.set(key, value);
        
        // å¯é€‰ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´
        redisClient.expire(key, 60);  // 60ç§’è¿‡æœŸ
    }

    @Override
    public void close() throws Exception {
        if (redisClient != null) {
            redisClient.close();
        }
    }
}
```

### 4.2 å¼‚æ­¥ Sink ä¼˜åŒ–ï¼ˆé«˜çº§ï¼‰
```java
public class AsyncOrderBookSink extends RichAsyncFunction<OrderBook, Void> {
    private transient RedisAsyncClient redisClient;

    @Override
    public void asyncInvoke(OrderBook orderBook, ResultFuture<Void> resultFuture) 
        throws Exception {
        
        // å¼‚æ­¥å†™å…¥ Redis
        CompletableFuture<String> future = redisClient.setAsync(key, value);
        
        // å›è°ƒå¤„ç†
        future.whenComplete((result, error) -> {
            if (error != null) {
                resultFuture.completeExceptionally(error);
            } else {
                resultFuture.complete(Collections.emptyList());
            }
        });
    }
}
```

**é¢è¯•è¦ç‚¹**ï¼š
- åŒæ­¥ Sinkï¼šç®€å•ä½†é˜»å¡ï¼Œé€‚åˆä½åååœºæ™¯
- å¼‚æ­¥ Sinkï¼šé«˜ååï¼Œä½†å®ç°å¤æ‚
- å¯é…ç½®é‡è¯•ç­–ç•¥åº”å¯¹ç½‘ç»œæŠ–åŠ¨

---

## 5. market-outer æ¨¡å—ä»£ç è§£æ

### 5.1 Spring Boot å¯åŠ¨ç±»
```java
@EnableScheduling
@SpringBootApplication
public class MarketOuterApplication {
    public static void main(String[] args) {
        // åˆå§‹åŒ– Redis å®¢æˆ·ç«¯
        RedisClient.init("localhost", 6379, "");
        
        // å¯åŠ¨ Spring Boot
        SpringApplication.run(MarketOuterApplication.class, args);
    }
}
```

**é¢è¯•è¦ç‚¹**ï¼š
- `@EnableScheduling`ï¼šå¯ç”¨å®šæ—¶ä»»åŠ¡
- Redis åœ¨ Spring å¯åŠ¨å‰åˆå§‹åŒ–ï¼Œä¾›å…¶ä»–ç»„ä»¶ä½¿ç”¨

### 5.2 WebSocket å®¢æˆ·ç«¯ï¼ˆæ¨æµ‹ï¼‰
```java
public class CryptoSocketClient extends BaseSocketClient {
    
    @Override
    public void onOpen(ServerHandshake handshake) {
        log.info("WebSocket connected");
        
        // å‘é€è®¢é˜…è¯·æ±‚
        CryptoRequest request = new CryptoRequest();
        request.setMethod("subscribe");
        request.setParams(Arrays.asList("book.BTC_USDT"));
        
        send(JSON.toJSONString(request));
    }

    @Override
    public void onMessage(String message) {
        // è§£ææ¶ˆæ¯
        CryptoEvent event = JSON.parseObject(message, CryptoEvent.class);
        
        // å†™å…¥ Redis æˆ– Kafka
        if ("book".equals(event.getChannel())) {
            redisWriter.writeOrderBook(event.getData());
        }
    }

    @Override
    public void onError(Exception ex) {
        log.error("WebSocket error", ex);
    }

    @Override
    public void onClose(int code, String reason, boolean remote) {
        log.warn("WebSocket closed: {}", reason);
        // é‡è¿é€»è¾‘
        scheduleReconnect();
    }
}
```

**é¢è¯•è¦ç‚¹**ï¼š
- ç»§æ‰¿ `WebSocketClient` å®ç°è‡ªå®šä¹‰é€»è¾‘
- å¿ƒè·³ä¿æ´»ï¼šå®šæœŸå‘é€ ping æ¶ˆæ¯
- æ–­çº¿é‡è¿ï¼šæŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ1s â†’ 2s â†’ 4s â†’ 8sï¼‰

---

## 6. å…³é”®æ•°æ®æ¨¡å‹

### 6.1 Orderï¼ˆè®¢å•ï¼‰
```java
public class Order {
    private Long contractId;      // åˆçº¦ID
    private String side;           // BID/ASK
    private String action;         // INSERT/DELETE
    private BigDecimal price;      // ä»·æ ¼
    private BigDecimal quantity;   // æ•°é‡
    private Long timestamp;        // æ—¶é—´æˆ³
}
```

### 6.2 OrderBookï¼ˆè®¢å•ç°¿ï¼‰
```java
public class OrderBook {
    private Long contractId;
    private Map<BigDecimal, BigDecimal> bids;  // ä¹°ç›˜
    private Map<BigDecimal, BigDecimal> asks;  // å–ç›˜
    private Double grouping;                   // åˆ†ç»„ç²’åº¦
    private Market market;
}
```

### 6.3 Tradeï¼ˆäº¤æ˜“ï¼‰
```java
public class Trade {
    private Long contractId;
    private BigDecimal price;
    private BigDecimal volume;
    private Long timestamp;
}
```

---

## 7. é¢è¯•å¸¸è§ä»£ç é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä½¿ç”¨ BigDecimal è€Œä¸æ˜¯ Doubleï¼Ÿ
**A**:
```java
// Double ç²¾åº¦é—®é¢˜
double a = 0.1 + 0.2;  // 0.30000000000000004

// BigDecimal ç²¾ç¡®è®¡ç®—
BigDecimal a = new BigDecimal("0.1");
BigDecimal b = new BigDecimal("0.2");
BigDecimal c = a.add(b);  // 0.3
```
é‡‘èåœºæ™¯å¿…é¡»ä½¿ç”¨ BigDecimal ä¿è¯è®¡ç®—ç²¾åº¦ã€‚

### Q2: å¦‚ä½•ä¿è¯ Flink ä½œä¸šçš„ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰ï¼Ÿ
**A**:
1. å¯ç”¨ Checkpoint
2. Kafka Source é…ç½® `ENABLE_AUTO_COMMIT=false`
3. Sink å®ç°å¹‚ç­‰å†™å…¥æˆ–äº‹åŠ¡å†™å…¥
4. ä»£ç ä¸­å·²ä½¿ç”¨ KeyedProcessFunction + Stateï¼Œè‡ªåŠ¨æ”¯æŒ

### Q3: å¦‚æœ Kafka æ¶ˆæ¯å †ç§¯æ€ä¹ˆåŠï¼Ÿ
**A**:
1. å¢åŠ å¹¶è¡Œåº¦ï¼ˆ`setParallelism()`ï¼‰
2. ä¼˜åŒ–å¤„ç†é€»è¾‘ï¼Œå‡å°‘è®¡ç®—æ—¶é—´
3. å¢åŠ  Kafka åˆ†åŒºæ•°
4. ä½¿ç”¨ Flink çš„ Backpressure æœºåˆ¶é™æµ

### Q4: å¦‚ä½•ç›‘æ§ Flink ä½œä¸šå¥åº·çŠ¶æ€ï¼Ÿ
**A**:
1. Flink Web UI (8081ç«¯å£)
2. Flink Metricsï¼ˆJMXã€Prometheusï¼‰
3. è‡ªå®šä¹‰ Metricï¼ˆå¦‚å¤„ç†å»¶è¿Ÿã€å¤±è´¥ç‡ï¼‰
4. æ—¥å¿—ç›‘æ§ï¼ˆELKï¼‰

---

## 8. ä»£ç ä¼˜åŒ–å»ºè®®ï¼ˆåŠ åˆ†é¡¹ï¼‰

### 8.1 å¢åŠ æ•°æ®å»é‡
```java
// ä½¿ç”¨ Flink State å»é‡
public class DeduplicateProcessor 
    extends KeyedProcessFunction<Long, Order, Order> {
    
    private ValueState<Long> lastSeenIdState;

    @Override
    public void processElement(Order order, Context ctx, Collector<Order> out) 
        throws Exception {
        Long lastSeenId = lastSeenIdState.value();
        if (lastSeenId == null || order.getId() > lastSeenId) {
            lastSeenIdState.update(order.getId());
            out.collect(order);
        } else {
            log.warn("Duplicate order: {}", order.getId());
        }
    }
}
```

### 8.2 å¢åŠ å»¶è¿Ÿç›‘æ§
```java
public class OrderBookProcessor 
    extends KeyedProcessFunction<Long, Order, OrderBook> {
    
    private transient Counter lateCounter;

    @Override
    public void open(Configuration parameters) throws Exception {
        lateCounter = getRuntimeContext()
            .getMetricGroup()
            .counter("late_orders");
        // ... å…¶ä»–åˆå§‹åŒ–
    }

    @Override
    public void processElement(Order order, Context ctx, Collector<OrderBook> out) 
        throws Exception {
        long delay = System.currentTimeMillis() - order.getTimestamp();
        if (delay > 5000) {
            lateCounter.inc();
            log.warn("Late order: {}ms", delay);
        }
        // ... å¤„ç†é€»è¾‘
    }
}
```

---

**ä»¥ä¸Šå°±æ˜¯æ ¸å¿ƒä»£ç çš„æ·±åº¦è§£æï¼Œå»ºè®®ç»“åˆå®é™…ä»£ç åå¤ç†è§£ï¼**
