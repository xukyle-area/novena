# Tampines é¡¹ç›®é¢è¯•å‡†å¤‡æ–‡æ¡£ - å¸¸è§é—®é¢˜ä¸ç­”æ¡ˆ

## ğŸ“‹ ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°ç±»é—®é¢˜](#1-é¡¹ç›®æ¦‚è¿°ç±»é—®é¢˜)
2. [æŠ€æœ¯é€‰å‹ç±»é—®é¢˜](#2-æŠ€æœ¯é€‰å‹ç±»é—®é¢˜)
3. [Flink ç›¸å…³é—®é¢˜](#3-flink-ç›¸å…³é—®é¢˜)
4. [æ€§èƒ½ä¼˜åŒ–ç±»é—®é¢˜](#4-æ€§èƒ½ä¼˜åŒ–ç±»é—®é¢˜)
5. [æ•…éšœå¤„ç†ç±»é—®é¢˜](#5-æ•…éšœå¤„ç†ç±»é—®é¢˜)
6. [æ‰©å±•æ€§é—®é¢˜](#6-æ‰©å±•æ€§é—®é¢˜)
7. [å®æˆ˜åœºæ™¯é¢˜](#7-å®æˆ˜åœºæ™¯é¢˜)

---

## 1. é¡¹ç›®æ¦‚è¿°ç±»é—®é¢˜

### Q1.1: è¯·ä»‹ç»ä¸€ä¸‹ä½ åšçš„è¿™ä¸ªé¡¹ç›®ï¼Ÿ
**æ ‡å‡†ç­”æ¡ˆ**ï¼š
> è¿™æ˜¯ä¸€ä¸ªåŸºäº Apache Flink çš„å®æ—¶é‡‘èå¸‚åœºæ•°æ®å¤„ç†ç³»ç»Ÿï¼Œå‘½åä¸º Tampinesã€‚é¡¹ç›®çš„æ ¸å¿ƒç›®æ ‡æ˜¯å¤„ç†äº¤æ˜“æ‰€çš„è®¢å•ç°¿å’Œè¡Œæƒ…æ•°æ®ï¼Œæä¾›ä½å»¶è¿Ÿã€é«˜ç²¾åº¦çš„å®æ—¶è®¡ç®—èƒ½åŠ›ã€‚
>
> **ä¸šåŠ¡åœºæ™¯**ï¼šç³»ç»Ÿä»åŠ å¯†è´§å¸äº¤æ˜“æ‰€ï¼ˆå¦‚ Crypto.comï¼‰é€šè¿‡ WebSocket æ¥å…¥å®æ—¶è®¢å•å’Œäº¤æ˜“æ•°æ®ï¼Œç»è¿‡ Flink æµå¤„ç†åç”Ÿæˆè®¢å•ç°¿æ·±åº¦ã€24å°æ—¶è¡Œæƒ…å’ŒKçº¿æ•°æ®ï¼Œå­˜å‚¨åˆ° Redis ä¾›å‰ç«¯æˆ–é‡åŒ–ç­–ç•¥ä½¿ç”¨ã€‚
>
> **æŠ€æœ¯æ¶æ„**ï¼šé‡‡ç”¨ä¸‰å±‚è®¾è®¡â€”â€”å¤–éƒ¨æ¥å£å±‚ï¼ˆmarket-outerï¼‰è´Ÿè´£æ•°æ®æ¥å…¥ï¼Œæµå¤„ç†æ ¸å¿ƒå±‚ï¼ˆmarket-flinkï¼‰è´Ÿè´£å®æ—¶è®¡ç®—ï¼Œå…¬å…±åŸºç¡€å±‚ï¼ˆmarket-commonï¼‰æä¾›å…±äº«ç»„ä»¶ã€‚æ ¸å¿ƒæŠ€æœ¯æ ˆæ˜¯ Flink 1.17ã€Kafka 3.1 å’Œ Redisã€‚
>
> **æˆ‘çš„èŒè´£**ï¼šä¸»è¦è´Ÿè´£ Flink ä½œä¸šçš„å¼€å‘ï¼ŒåŒ…æ‹¬ OrderbookJobï¼ˆè®¢å•ç°¿ç»´æŠ¤ï¼‰ã€TickerJobï¼ˆè¡Œæƒ…èšåˆï¼‰å’Œ CandleJobï¼ˆKçº¿ç”Ÿæˆï¼‰ï¼Œå…¶ä¸­ OrderbookJob æ˜¯æœ€æ ¸å¿ƒçš„æ¨¡å—ï¼Œä½¿ç”¨ Flink MapState å®ç°é«˜æ€§èƒ½è®¢å•ç°¿ç»´æŠ¤ã€‚

**åŠ åˆ†ç‚¹**ï¼š
- å¼ºè°ƒ**å®æ—¶æ€§**ï¼ˆæ¯«ç§’çº§å»¶è¿Ÿï¼‰
- å¼ºè°ƒ**ç²¾ç¡®æ€§**ï¼ˆBigDecimal é‡‘èè®¡ç®—ï¼‰
- é‡åŒ–æ•°æ®è§„æ¨¡ï¼ˆå¦‚æ¯ç§’å¤„ç†Xä¸‡æ¡è®¢å•ï¼‰

---

### Q1.2: è¿™ä¸ªé¡¹ç›®è§£å†³äº†ä»€ä¹ˆä¸šåŠ¡ç—›ç‚¹ï¼Ÿ
**ç­”æ¡ˆ**ï¼š
1. **å®æ—¶æ€§é—®é¢˜**ï¼šä¼ ç»Ÿæ‰¹å¤„ç†æ¶æ„å»¶è¿Ÿé«˜ï¼ˆåˆ†é’Ÿçº§ï¼‰ï¼Œæ— æ³•æ»¡è¶³é«˜é¢‘äº¤æ˜“éœ€æ±‚ã€‚Flink æµå¤„ç†å®ç°æ¯«ç§’çº§å»¶è¿Ÿã€‚

2. **è®¢å•ç°¿ç»´æŠ¤å¤æ‚**ï¼šè®¢å•ç°¿éœ€è¦é¢‘ç¹çš„å¢åˆ æ”¹æ“ä½œï¼Œä¸”è¦ä¿è¯å¤šä¸ªä»·æ ¼æ¡£ä½çš„å‡†ç¡®æ€§ã€‚ä½¿ç”¨ Flink MapState å®ç°é«˜æ•ˆçŠ¶æ€ç®¡ç†ã€‚

3. **å¤šç»´åº¦æ•°æ®èšåˆ**ï¼šéœ€è¦åŒæ—¶æä¾›å¤šç§ç²¾åº¦çš„è®¢å•ç°¿ï¼ˆresolution 1/5/10ï¼‰ã€24å°æ—¶è¡Œæƒ…ã€å¤šå‘¨æœŸKçº¿ã€‚Flink å¤š Job å¹¶è¡Œè®¡ç®—ã€‚

4. **é«˜å¹¶å‘æ•°æ®æ¥å…¥**ï¼šå¤šä¸ªäº¤æ˜“æ‰€ã€å¤šä¸ªäº¤æ˜“å¯¹çš„æ•°æ®åŒæ—¶æ¥å…¥ï¼Œé€šè¿‡ Kafka è§£è€¦å’Œå‰Šå³°ã€‚

---

### Q1.3: é¡¹ç›®ä¸­é‡åˆ°çš„æœ€å¤§æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ
**STAR æ³•åˆ™å›ç­”**ï¼š
- **Situationï¼ˆæƒ…å¢ƒï¼‰**ï¼šOrderbookJob è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå‘ç° Flink TaskManager å†…å­˜å ç”¨æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚

- **Taskï¼ˆä»»åŠ¡ï¼‰**ï¼šéœ€è¦å®šä½å†…å­˜æ³„æ¼åŸå› å¹¶ä¼˜åŒ–çŠ¶æ€å­˜å‚¨ã€‚

- **Actionï¼ˆè¡ŒåŠ¨ï¼‰**ï¼š
  1. é€šè¿‡ Flink Metrics å’Œ State Backend ç›‘æ§å‘ç° MapState æ•°é‡æš´å¢
  2. åˆ†æå‘ç°æŸäº›äº¤æ˜“å¯¹çš„è®¢å•ä»·æ ¼æåº¦åˆ†æ•£ï¼Œå¯¼è‡´ä»·æ ¼æ¡£ä½æ•°é‡è¿‡å¤š
  3. å®ç°ä»·æ ¼åˆ†ç»„ç®—æ³•ï¼ˆ`groupPrice()`ï¼‰ï¼Œå°†ç›¸è¿‘ä»·æ ¼åˆå¹¶åˆ°åŒä¸€æ¡£ä½
  4. å¢åŠ æ•°é‡ä¸º0æ—¶åˆ é™¤æ¡£ä½çš„é€»è¾‘ï¼Œé¿å…æ— æ•ˆçŠ¶æ€ç´¯ç§¯
  5. ä» HeapStateBackend åˆ‡æ¢åˆ° RocksDB StateBackendï¼Œæ”¯æŒæ›´å¤§çŠ¶æ€

- **Resultï¼ˆç»“æœï¼‰**ï¼š
  - å†…å­˜å ç”¨é™ä½ 70%
  - æ”¯æŒè¿è¡Œä¸€ä¸ªæœˆæ— é‡å¯
  - å¤„ç†æ€§èƒ½æå‡ 40%

**åŠ åˆ†ç‚¹**ï¼š
- å±•ç¤ºé—®é¢˜åˆ†æèƒ½åŠ›
- å±•ç¤ºä¼˜åŒ–æ€è·¯å’Œå…·ä½“æªæ–½
- ç”¨æ•°æ®è¯´è¯

---

## 2. æŠ€æœ¯é€‰å‹ç±»é—®é¢˜

### Q2.1: ä¸ºä»€ä¹ˆé€‰æ‹© Flink è€Œä¸æ˜¯ Spark Streaming æˆ– Stormï¼Ÿ
**å¯¹æ¯”åˆ†æ**ï¼š

| ç‰¹æ€§             | Flink              | Spark Streaming | Storm      |
| ---------------- | ------------------ | --------------- | ---------- |
| **æµå¤„ç†æ¨¡å‹**   | åŸç”Ÿæµå¤„ç†         | å¾®æ‰¹å¤„ç†        | åŸç”Ÿæµå¤„ç† |
| **å»¶è¿Ÿ**         | æ¯«ç§’çº§             | ç§’çº§            | æ¯«ç§’çº§     |
| **çŠ¶æ€ç®¡ç†**     | å¼ºå¤§ï¼ˆMapStateç­‰ï¼‰ | è¾ƒå¼±            | åŸºç¡€       |
| **ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰** | æ”¯æŒ               | æ”¯æŒ            | ä»…è‡³å°‘ä¸€æ¬¡ |
| **SQL æ”¯æŒ**     | ä¼˜ç§€               | ä¸€èˆ¬            | æ—          |
| **ç”Ÿæ€æˆç†Ÿåº¦**   | é«˜                 | æœ€é«˜            | ä¸€èˆ¬       |

**ç»“è®º**ï¼š
- **é€‰æ‹© Flink** çš„åŸå› ï¼š
  1. åŸç”Ÿæµå¤„ç†ï¼Œä½å»¶è¿Ÿï¼ˆè®¢å•ç°¿éœ€è¦å®æ—¶æ›´æ–°ï¼‰
  2. MapState éå¸¸é€‚åˆç»´æŠ¤è®¢å•ç°¿è¿™ç§é”®å€¼ç»“æ„
  3. ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰ä¿è¯é‡‘èæ•°æ®ä¸€è‡´æ€§
  4. RocksDB StateBackend æ”¯æŒå¤§çŠ¶æ€å­˜å‚¨
  5. Kafka Connector æˆç†Ÿç¨³å®š

---

### Q2.2: ä¸ºä»€ä¹ˆä½¿ç”¨ Kafka è€Œä¸æ˜¯ç›´æ¥å†™ Flinkï¼Ÿ
**ç­”æ¡ˆ**ï¼š
1. **è§£è€¦**ï¼šmarket-outer å’Œ market-flink è§£è€¦ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œå‡çº§
2. **å‰Šå³°å¡«è°·**ï¼šKafka ç¼“å†²çªå‘æµé‡ï¼Œé¿å… Flink è¿‡è½½
3. **æ•°æ®å›æ”¾**ï¼šå‡ºé—®é¢˜æ—¶å¯ä»¥é‡æ–°æ¶ˆè´¹ Kafka æ•°æ®
4. **å¤šè®¢é˜…**ï¼šåŒä¸€ä»½æ•°æ®å¯ä»¥è¢«å¤šä¸ª Flink Job æ¶ˆè´¹ï¼ˆå¦‚ OrderbookJobã€TickerJobï¼‰
5. **æŒä¹…åŒ–**ï¼šKafka ä¿ç•™ä¸€å®šæ—¶é—´çš„æ•°æ®ï¼Œå¢å¼ºå®¹é”™èƒ½åŠ›

---

### Q2.3: ä¸ºä»€ä¹ˆç”¨ Redis è€Œä¸æ˜¯ MySQL å­˜å‚¨ç»“æœï¼Ÿ
**ç­”æ¡ˆ**ï¼š
1. **è¯»å†™æ€§èƒ½**ï¼šRedis å†…å­˜æ“ä½œï¼ŒQPS 10ä¸‡+ï¼›MySQL ç£ç›˜IOï¼ŒQPS å‡ åƒ
2. **æ•°æ®ç»“æ„**ï¼šè®¢å•ç°¿æ˜¯ Map ç»“æ„ï¼ˆä»·æ ¼â†’æ•°é‡ï¼‰ï¼ŒRedis åŸç”Ÿæ”¯æŒ
3. **è¿‡æœŸæœºåˆ¶**ï¼šRedis TTL è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤
4. **å®æ—¶æŸ¥è¯¢**ï¼šå‰ç«¯æ¯ç§’æŸ¥è¯¢å¤šæ¬¡ï¼ŒRedis ä½å»¶è¿Ÿï¼ˆ<1msï¼‰

**è¡¥å……**ï¼š
- å†å²æ•°æ®å¯ä»¥å¼‚æ­¥å†™å…¥ MySQL/ClickHouse åšç¦»çº¿åˆ†æ
- æ ¸å¿ƒå®æ—¶æ•°æ®ç”¨ Redisï¼Œå†·æ•°æ®ç”¨å…³ç³»å‹æ•°æ®åº“

---

## 3. Flink ç›¸å…³é—®é¢˜

### Q3.1: Flink çš„ Checkpoint æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ
**ç­”æ¡ˆ**ï¼š
Checkpoint æ˜¯ Flink å®ç°å®¹é”™å’Œç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰çš„æ ¸å¿ƒæœºåˆ¶ã€‚

**å·¥ä½œåŸç†**ï¼š
1. **Barrier æ³¨å…¥**ï¼šJobManager å®šæœŸå‘ Source æ³¨å…¥ Checkpoint Barrier
2. **Barrier æµè½¬**ï¼šBarrier éšæ•°æ®æµå‘ä¸‹æ¸¸ä¼ æ’­
3. **çŠ¶æ€å¿«ç…§**ï¼šç®—å­æ”¶åˆ° Barrier æ—¶ï¼Œä¿å­˜å½“å‰çŠ¶æ€åˆ°å¤–éƒ¨å­˜å‚¨ï¼ˆå¦‚ HDFSï¼‰
4. **ç¡®è®¤å®Œæˆ**ï¼šæ‰€æœ‰ç®—å­å®Œæˆå¿«ç…§åï¼ŒCheckpoint æˆåŠŸ

**å…³é”®é…ç½®**ï¼ˆé¡¹ç›®ä¸­ï¼‰ï¼š
```java
see.enableCheckpointing(60000);  // æ¯60ç§’ä¸€æ¬¡
see.getCheckpointConfig()
   .setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);  // ç²¾ç¡®ä¸€æ¬¡
see.setStateBackend(new RocksDBStateBackend("hdfs://..."));  // çŠ¶æ€å­˜å‚¨
```

**æ¢å¤æµç¨‹**ï¼š
- ä½œä¸šå¤±è´¥æ—¶ï¼Œä»æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„ Checkpoint æ¢å¤çŠ¶æ€
- Kafka Offset ä¹Ÿä¼šå›æ»šï¼Œé‡æ–°æ¶ˆè´¹æ•°æ®
- ä¿è¯ä¸ä¸¢æ•°æ®ã€ä¸é‡å¤è®¡ç®—

---

### Q3.2: Flink çš„ State æœ‰å“ªäº›ç±»å‹ï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### 1. Keyed Stateï¼ˆé”®æ§çŠ¶æ€ï¼‰
å¿…é¡»åœ¨ `keyBy()` åä½¿ç”¨ï¼Œæ¯ä¸ª Key ç‹¬ç«‹ç»´æŠ¤çŠ¶æ€ã€‚

- **ValueState<T>**ï¼šå•å€¼çŠ¶æ€
  ```java
  ValueState<Long> lastSeenId;
  lastSeenId.update(newId);
  ```

- **MapState<K, V>**ï¼šMap çŠ¶æ€ï¼ˆé¡¹ç›®ä¸­ä½¿ç”¨ï¼‰
  ```java
  MapState<BigDecimal, BigDecimal> bidState;
  bidState.put(price, quantity);
  ```

- **ListState<T>**ï¼šåˆ—è¡¨çŠ¶æ€
- **ReducingState<T>**ï¼šç´¯åŠ çŠ¶æ€
- **AggregatingState<IN, OUT>**ï¼šèšåˆçŠ¶æ€

#### 2. Operator Stateï¼ˆç®—å­çŠ¶æ€ï¼‰
æ‰€æœ‰å¹¶è¡Œåº¦å…±äº«çš„çŠ¶æ€ï¼ˆå¦‚ Kafka Offsetï¼‰ã€‚

**é¡¹ç›®ä¸­çš„ä½¿ç”¨**ï¼š
- OrderBookProcessor ä½¿ç”¨ **MapState** ç»´æŠ¤è®¢å•ç°¿
- TickerAggregator ä½¿ç”¨å†…ç½®çš„èšåˆçŠ¶æ€

---

### Q3.3: Flink çš„ Watermark æ˜¯ä»€ä¹ˆï¼Ÿé¡¹ç›®ä¸­ç”¨äº†å—ï¼Ÿ
**ç­”æ¡ˆ**ï¼š
Watermark ç”¨äºå¤„ç†**ä¹±åºæ•°æ®**å’Œ**è§¦å‘çª—å£è®¡ç®—**ã€‚

**æ¦‚å¿µ**ï¼š
- Watermark(T) è¡¨ç¤º"æ—¶é—´æˆ³ â‰¤ T çš„æ•°æ®å·²å…¨éƒ¨åˆ°è¾¾"
- çª—å£åªæœ‰æ”¶åˆ° Watermark æ‰ä¼šè§¦å‘è®¡ç®—

**é¡¹ç›®ä¸­çš„ä½¿ç”¨**ï¼š
```java
// OrderbookJob ä½¿ç”¨ Processing Timeï¼Œä¸éœ€è¦ Watermark
see.fromSource(source, WatermarkStrategy.noWatermarks(), KAFKA_SOURCE);

// TickerJob ä½¿ç”¨ Event Timeï¼Œåº”è¯¥é…ç½® Watermark
WatermarkStrategy<Trade> watermarkStrategy = WatermarkStrategy
    .<Trade>forBoundedOutOfOrderness(Duration.ofSeconds(5))
    .withTimestampAssigner((trade, ts) -> trade.getTimestamp());
```

**ä¸ºä»€ä¹ˆ OrderbookJob ä¸ç”¨ Watermark**ï¼š
- ä½¿ç”¨ Processing Timeï¼ˆå¤„ç†æ—¶é—´ï¼‰è€Œé Event Timeï¼ˆäº‹ä»¶æ—¶é—´ï¼‰
- é€šè¿‡å®šæ—¶å™¨æ¯ç§’è§¦å‘è¾“å‡ºï¼Œå¯¹æ•°æ®é¡ºåºè¦æ±‚ä¸é«˜
- ç®€åŒ–é€»è¾‘ï¼Œé¿å… Watermark å¸¦æ¥çš„å¤æ‚æ€§

---

### Q3.4: Flink å¦‚ä½•ä¿è¯ç²¾ç¡®ä¸€æ¬¡ï¼ˆExactly-Onceï¼‰ï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### 1. Source ç«¯
- Kafka Source å…³é—­è‡ªåŠ¨æäº¤ï¼ŒFlink ç®¡ç† Offset
- Checkpoint æ—¶è®°å½•æ¶ˆè´¹ä½ç½®
- å¤±è´¥æ—¶ä» Checkpoint ä¸­çš„ Offset é‡æ–°æ¶ˆè´¹

#### 2. è®¡ç®—ç«¯
- Checkpoint ä¿å­˜æ‰€æœ‰ç®—å­çš„çŠ¶æ€å¿«ç…§
- Barrier å¯¹é½æœºåˆ¶ä¿è¯çŠ¶æ€ä¸€è‡´æ€§
- æ¢å¤æ—¶ä»å¿«ç…§æ¢å¤ï¼Œé‡æ–°è®¡ç®—

#### 3. Sink ç«¯
- **å¹‚ç­‰å†™å…¥**ï¼šåŒä¸€æ•°æ®å¤šæ¬¡å†™å…¥ç»“æœç›¸åŒï¼ˆå¦‚ Redis SET æ“ä½œï¼‰
- **äº‹åŠ¡å†™å…¥**ï¼šTwo-Phase Commitï¼ˆå¦‚ Kafka Sinkï¼‰

**é¡¹ç›®ä¸­çš„å®ç°**ï¼š
```java
// Kafka Source ä¸è‡ªåŠ¨æäº¤ Offset
KafkaSource.builder()
    .setProperty("enable.auto.commit", "false")
    .build();

// Redis Sink å¤©ç„¶å¹‚ç­‰ï¼ˆSET è¦†ç›–å†™ï¼‰
redisClient.set(key, value);
```

---

### Q3.5: å¦‚ä½•è®¾ç½® Flink çš„å¹¶è¡Œåº¦ï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### å¹¶è¡Œåº¦è®¾ç½®æ–¹å¼ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š
1. **ç®—å­çº§åˆ«**ï¼š
   ```java
   stream.map(...).setParallelism(4);
   ```

2. **æ‰§è¡Œç¯å¢ƒçº§åˆ«**ï¼š
   ```java
   see.setParallelism(2);
   ```

3. **é…ç½®æ–‡ä»¶çº§åˆ«**ï¼š
   ```yaml
   # flink-conf.yaml
   parallelism.default: 1
   ```

4. **æäº¤ä½œä¸šæ—¶æŒ‡å®š**ï¼š
   ```bash
   flink run -p 8 my-job.jar
   ```

**é¡¹ç›®ä¸­çš„è®¾ç½®**ï¼š
```java
// å…¨å±€è®¾ç½®ä¸º 1ï¼ˆå•å¹¶è¡Œåº¦ï¼Œä¿è¯é¡ºåºï¼‰
see.setParallelism(ONE);

// åŸå› ï¼š
// 1. è®¢å•ç°¿éœ€è¦ä¸¥æ ¼æŒ‰ Key èšåˆï¼Œå•å¹¶è¡Œåº¦é¿å…åˆ†åŒºé—®é¢˜
// 2. æ¯ä¸ªäº¤æ˜“å¯¹ç‹¬ç«‹è®¡ç®—ï¼Œå•å¹¶è¡Œåº¦å·²è¶³å¤Ÿ
// 3. æ•°æ®é‡ä¸å¤§ï¼ˆæµ‹è¯•/å¼€å‘ç¯å¢ƒï¼‰
```

**ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–**ï¼š
- Kafka åˆ†åŒºæ•° = Flink å¹¶è¡Œåº¦ï¼ˆå……åˆ†åˆ©ç”¨èµ„æºï¼‰
- Source/Sink é«˜å¹¶è¡Œåº¦ï¼ŒProcessFunction ä½å¹¶è¡Œåº¦
- æ ¹æ®ç›‘æ§åŠ¨æ€è°ƒæ•´

---

## 4. æ€§èƒ½ä¼˜åŒ–ç±»é—®é¢˜

### Q4.1: å¦‚ä½•ä¼˜åŒ– Flink ä½œä¸šçš„æ€§èƒ½ï¼Ÿ
**å¤šç»´åº¦ä¼˜åŒ–ç­–ç•¥**ï¼š

#### 1. å¹¶è¡Œåº¦ä¼˜åŒ–
```java
// ä¸åŒç®—å­ä¸åŒå¹¶è¡Œåº¦
source.setParallelism(4)      // Source é«˜å¹¶è¡Œåº¦è¯»å–
      .keyBy(...)
      .process(...).setParallelism(2)  // è®¡ç®—é€‚ä¸­
      .addSink(...).setParallelism(4);  // Sink é«˜å¹¶è¡Œåº¦å†™å…¥
```

#### 2. çŠ¶æ€ä¼˜åŒ–
```java
// ä½¿ç”¨ RocksDB æ”¯æŒå¤§çŠ¶æ€
see.setStateBackend(new RocksDBStateBackend("hdfs://..."));

// é…ç½®å¢é‡ Checkpoint
see.getCheckpointConfig().enableIncrementalCheckpoints(true);

// è®¾ç½® State TTL è‡ªåŠ¨æ¸…ç†è¿‡æœŸçŠ¶æ€
StateTtlConfig ttlConfig = StateTtlConfig
    .newBuilder(Time.days(1))
    .setUpdateType(UpdateType.OnCreateAndWrite)
    .build();
descriptor.enableTimeToLive(ttlConfig);
```

#### 3. ç½‘ç»œä¼˜åŒ–
```java
// è°ƒæ•´ç¼“å†²åŒºå¤§å°
see.getConfig().setNetworkBufferTimeout(100);  // 100ms
```

#### 4. ç®—å­é“¾ä¼˜åŒ–
```java
// ç¦ç”¨ç®—å­é“¾ï¼ˆè°ƒè¯•æ—¶ï¼‰
see.disableOperatorChaining();

// æŒ‡å®šç®—å­é“¾
stream.map(...).startNewChain();
```

#### 5. æ•°æ®å€¾æ–œå¤„ç†
```java
// KeyBy å‰å¢åŠ éšæœºå‰ç¼€
.map(data -> {
    int random = ThreadLocalRandom.current().nextInt(10);
    return Tuple2.of(random + "_" + data.getKey(), data);
})
.keyBy(0)
```

**é¡¹ç›®ä¸­çš„å®è·µ**ï¼š
- ä»·æ ¼åˆ†ç»„ç®—æ³•å‡å°‘çŠ¶æ€æ•°é‡ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
- åˆ é™¤æ•°é‡ä¸º0çš„ä»·æ ¼æ¡£ä½ï¼Œé¿å…çŠ¶æ€ç´¯ç§¯
- RocksDB StateBackend æ”¯æŒå¤§çŠ¶æ€

---

### Q4.2: å¦‚ä½•å¤„ç†æ•°æ®å€¾æ–œï¼Ÿ
**ç­”æ¡ˆ**ï¼š

**è¯†åˆ«æ•°æ®å€¾æ–œ**ï¼š
- Flink Web UI æŸ¥çœ‹ SubTask çš„å¤„ç†è®°å½•æ•°
- æŸäº› SubTask å¤„ç†é‡è¿œå¤§äºå…¶ä»–

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### æ–¹æ¡ˆ1ï¼šKeyBy å‰å¢åŠ éšæœºå‰ç¼€
```java
// ä¸¤é˜¶æ®µèšåˆ
// ç¬¬ä¸€é˜¶æ®µï¼šå±€éƒ¨èšåˆ
stream.map(data -> {
    int salt = random.nextInt(10);
    return Tuple2.of(salt + "_" + data.getKey(), data);
})
.keyBy(0)
.reduce(...)

// ç¬¬äºŒé˜¶æ®µï¼šå…¨å±€èšåˆ
.map(data -> data.f1)  // å»é™¤éšæœºå‰ç¼€
.keyBy(...)
.reduce(...)
```

#### æ–¹æ¡ˆ2ï¼šè‡ªå®šä¹‰åˆ†åŒºå™¨
```java
stream.partitionCustom(new Partitioner<String>() {
    @Override
    public int partition(String key, int numPartitions) {
        // çƒ­ç‚¹ Key ç‰¹æ®Šå¤„ç†
        if (isHotKey(key)) {
            return ThreadLocalRandom.current().nextInt(numPartitions);
        }
        return key.hashCode() % numPartitions;
    }
}, KeySelector);
```

#### æ–¹æ¡ˆ3ï¼šè¿‡æ»¤çƒ­ç‚¹æ•°æ®
```java
// å°†çƒ­ç‚¹äº¤æ˜“å¯¹å•ç‹¬å¤„ç†
stream.split(data -> {
    if (isHotContract(data.getContractId())) {
        return "hot";
    }
    return "normal";
})
.select("hot").setParallelism(8)   // çƒ­ç‚¹é«˜å¹¶è¡Œåº¦
.union(
    stream.select("normal").setParallelism(2)  // æ™®é€šä½å¹¶è¡Œåº¦
);
```

---

### Q4.3: å¦‚ä½•ç›‘æ§ Flink ä½œä¸šï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### 1. Flink Web UI (8081ç«¯å£)
- **Overview**ï¼šæ€»ä½“è¿è¡ŒçŠ¶æ€ã€TaskManageræ•°é‡
- **Jobs**ï¼šä½œä¸šåˆ—è¡¨ã€è¿è¡Œæ—¶é—´
- **Task Metrics**ï¼šæ¯ä¸ªç®—å­çš„å¤„ç†é€Ÿåº¦ã€Backpressure
- **Checkpoints**ï¼šæˆåŠŸ/å¤±è´¥æ¬¡æ•°ã€è€—æ—¶

#### 2. Flink Metrics
```java
public class OrderBookProcessor 
    extends KeyedProcessFunction<Long, Order, OrderBook> {
    
    private transient Counter processedOrders;
    private transient Meter processingRate;

    @Override
    public void open(Configuration parameters) {
        MetricGroup metricGroup = getRuntimeContext().getMetricGroup();
        
        // è®¡æ•°å™¨
        processedOrders = metricGroup.counter("processed_orders");
        
        // é€Ÿç‡
        processingRate = metricGroup.meter("processing_rate", 
            new MeterView(60));  // 60ç§’çª—å£
        
        // åˆ†å¸ƒç»Ÿè®¡
        metricGroup.gauge("orderbook_size", () -> bidState.keys().iterator().hasNext() ? 1 : 0);
    }

    @Override
    public void processElement(...) {
        processedOrders.inc();
        processingRate.markEvent();
        // ...
    }
}
```

#### 3. å¤–éƒ¨ç›‘æ§ç³»ç»Ÿ
- **Prometheus + Grafana**ï¼šé‡‡é›† Flink Metricsï¼Œå¯è§†åŒ–å±•ç¤º
- **ELK**ï¼šæ”¶é›†æ—¥å¿—ï¼Œåˆ†æå¼‚å¸¸
- **AlertManager**ï¼šå‘Šè­¦é€šçŸ¥

**å…³é”®æŒ‡æ ‡**ï¼š
- **Throughput**ï¼ˆååé‡ï¼‰ï¼šrecords/s
- **Latency**ï¼ˆå»¶è¿Ÿï¼‰ï¼šend-to-end latency
- **Backpressure**ï¼ˆåå‹ï¼‰ï¼š0-1ï¼Œæ¥è¿‘1è¡¨ç¤ºå‹åŠ›å¤§
- **Checkpoint Duration**ï¼šCheckpoint è€—æ—¶
- **State Size**ï¼šçŠ¶æ€å¤§å°

---

## 5. æ•…éšœå¤„ç†ç±»é—®é¢˜

### Q5.1: å¦‚æœ Flink ä½œä¸šæŒ‚äº†æ€ä¹ˆåŠï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### è‡ªåŠ¨æ¢å¤
```java
// é…ç½®é‡å¯ç­–ç•¥
see.setRestartStrategy(RestartStrategies.failureRateRestart(
    3,                              // æœ€å¤§å¤±è´¥æ¬¡æ•°
    Time.of(5, TimeUnit.MINUTES),   // æ—¶é—´çª—å£
    Time.of(10, TimeUnit.SECONDS)   // é‡å¯é—´éš”
));
```

**é‡å¯æµç¨‹**ï¼š
1. Flink æ£€æµ‹åˆ° TaskManager å¤±è´¥
2. å–æ¶ˆæ‰€æœ‰ Task
3. ä»æœ€è¿‘çš„ Checkpoint æ¢å¤çŠ¶æ€
4. é‡æ–°æäº¤ Task
5. Kafka Source ä» Checkpoint è®°å½•çš„ Offset ç»§ç»­æ¶ˆè´¹

#### å¸¸è§å¤±è´¥åŸå› 
1. **OOM**ï¼šå¢åŠ å†…å­˜ã€ä¼˜åŒ–çŠ¶æ€
2. **ç½‘ç»œå¼‚å¸¸**ï¼šé…ç½®é‡è¯•ã€è¶…æ—¶
3. **å¤–éƒ¨ä¾èµ–ä¸å¯ç”¨**ï¼ˆå¦‚ Redisï¼‰ï¼šå¥åº·æ£€æŸ¥ã€é™çº§
4. **æ•°æ®å¼‚å¸¸**ï¼šå¢åŠ å¼‚å¸¸å¤„ç†ã€è¿‡æ»¤è„æ•°æ®

---

### Q5.2: Redis ä¸å¯ç”¨æ€ä¹ˆåŠï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### æ–¹æ¡ˆ1ï¼šé‡è¯•æœºåˆ¶
```java
public class OrderBookSink extends RichSinkFunction<OrderBook> {
    private static final int MAX_RETRIES = 3;

    @Override
    public void invoke(OrderBook orderBook, Context context) {
        for (int i = 0; i < MAX_RETRIES; i++) {
            try {
                redisClient.set(key, value);
                return;  // æˆåŠŸåˆ™è¿”å›
            } catch (Exception e) {
                if (i == MAX_RETRIES - 1) {
                    throw e;  // æœ€åä¸€æ¬¡å¤±è´¥åˆ™æŠ›å‡º
                }
                Thread.sleep(1000 * (i + 1));  // æŒ‡æ•°é€€é¿
            }
        }
    }
}
```

#### æ–¹æ¡ˆ2ï¼šé™çº§ç­–ç•¥
```java
if (!redisClient.isAvailable()) {
    // é™çº§ï¼šå†™å…¥æœ¬åœ°æ–‡ä»¶
    localFileWriter.write(orderBook);
    // åç»­å¼‚æ­¥è¡¥å¿
}
```

#### æ–¹æ¡ˆ3ï¼šåŒå†™
```java
// åŒæ—¶å†™å…¥ Redis å’Œ Kafka
redisClient.set(key, value);
kafkaProducer.send("result_topic", value);  // å¤‡ä»½
```

#### æ–¹æ¡ˆ4ï¼šRedis é«˜å¯ç”¨
- Redis Sentinelï¼ˆå“¨å…µæ¨¡å¼ï¼‰ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§»
- Redis Clusterï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰ï¼šåˆ†ç‰‡+é«˜å¯ç”¨

---

### Q5.3: Kafka æ¶ˆæ¯å †ç§¯æ€ä¹ˆåŠï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### 1. ä¸´æ—¶æ‰©å®¹
```bash
# å¢åŠ  Flink å¹¶è¡Œåº¦
flink run -p 8 my-job.jar  # ä»4å¢åŠ åˆ°8
```

#### 2. ä¼˜åŒ–ä»£ç 
- å‡å°‘é‡è®¡ç®—
- å¼‚æ­¥ IO æ›¿ä»£åŒæ­¥ IO
- æ‰¹é‡å†™å…¥æ›¿ä»£å•æ¡å†™å…¥

#### 3. å¢åŠ  Kafka åˆ†åŒº
```bash
kafka-topics.sh --alter --topic order --partitions 16
```
**æ³¨æ„**ï¼šFlink å¹¶è¡Œåº¦ä¹Ÿè¦ç›¸åº”å¢åŠ 

#### 4. é™æµ
```java
// å¯¹ä¸‹æ¸¸å‹åŠ›å¤§çš„ç®—å­é™æµ
stream.rescale().setParallelism(2);  // å‡å°‘å¹¶è¡Œåº¦
```

#### 5. ä¸´æ—¶åœæ­¢ä½ä¼˜å…ˆçº§ Job
- ä¼˜å…ˆä¿è¯æ ¸å¿ƒ Jobï¼ˆå¦‚ OrderbookJobï¼‰
- æš‚åœæ¬¡è¦ Jobï¼ˆå¦‚ CandleJobï¼‰

---

### Q5.4: å¦‚ä½•å¤„ç†è„æ•°æ®ï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### æ–¹æ¡ˆ1ï¼šè¿‡æ»¤æ— æ•ˆæ•°æ®
```java
stream.filter(order -> {
    if (order.getPrice() == null || order.getPrice().compareTo(BigDecimal.ZERO) <= 0) {
        log.warn("Invalid order: {}", order);
        return false;
    }
    return true;
});
```

#### æ–¹æ¡ˆ2ï¼šå¼‚å¸¸æ•è·
```java
@Override
public void processElement(Order order, Context ctx, Collector<OrderBook> out) {
    try {
        // å¤„ç†é€»è¾‘
    } catch (Exception e) {
        log.error("Process failed: {}", order, e);
        // è®°å½•åˆ°ä¾§è¾“å‡ºæµ
        ctx.output(errorTag, order);
    }
}
```

#### æ–¹æ¡ˆ3ï¼šä¾§è¾“å‡ºæµï¼ˆSide Outputï¼‰
```java
// å®šä¹‰ä¾§è¾“å‡ºæ ‡ç­¾
OutputTag<Order> errorTag = new OutputTag<Order>("error-orders") {};

// ä¸»æµæ­£å¸¸å¤„ç†ï¼Œå¼‚å¸¸æ•°æ®è¾“å‡ºåˆ°ä¾§è¾“å‡ºæµ
DataStream<OrderBook> mainStream = ...
DataStream<Order> errorStream = mainStream.getSideOutput(errorTag);

// é”™è¯¯æ•°æ®å•ç‹¬å¤„ç†ï¼ˆå¦‚è®°å½•æ—¥å¿—ã€å‘Šè­¦ï¼‰
errorStream.addSink(new ErrorLogSink());
```

---

## 6. æ‰©å±•æ€§é—®é¢˜

### Q6.1: å¦‚æœè¦æ”¯æŒæ–°çš„äº¤æ˜“æ‰€ï¼Œå¦‚ä½•æ‰©å±•ï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### 1. å¢åŠ æ–°çš„ WebSocket å®¢æˆ·ç«¯
```java
// æ–°å¢ BinanceSocketClient
public class BinanceSocketClient extends BaseSocketClient {
    @Override
    public void onMessage(String message) {
        // è§£æ Binance ç‰¹æœ‰æ ¼å¼
        BinanceEvent event = parseMessage(message);
        
        // è½¬æ¢ä¸ºç»Ÿä¸€æ¨¡å‹
        Order order = convertToOrder(event);
        
        // å†™å…¥ Kafka
        kafkaProducer.send("order", order);
    }
}
```

#### 2. ç»Ÿä¸€æ•°æ®æ¨¡å‹
```java
// market-common ä¸­å®šä¹‰ç»Ÿä¸€æ¨¡å‹
public class Order {
    private Long contractId;
    private String exchange;  // æ–°å¢ï¼šäº¤æ˜“æ‰€æ ‡è¯†
    // ...
}
```

#### 3. é…ç½®åŒ–ç®¡ç†
```yaml
# application.yml
exchanges:
  - name: crypto.com
    websocket: wss://stream.crypto.com/v2/market
    symbols: [BTC_USDT, ETH_USDT]
  - name: binance
    websocket: wss://stream.binance.com:9443/ws
    symbols: [BTCUSDT, ETHUSDT]
```

#### 4. Flink ä½œä¸šæ— éœ€ä¿®æ”¹
- åªè¦æ•°æ®æ ¼å¼ç»Ÿä¸€ï¼ŒFlink ä½œä¸šé€æ˜å¤„ç†
- é€šè¿‡ `exchange` å­—æ®µåŒºåˆ†æ•°æ®æ¥æº

---

### Q6.2: å¦‚ä½•æ”¯æŒæ›´å¤šäº¤æ˜“å¯¹ï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### 1. åŠ¨æ€é…ç½®
```java
// ä»é…ç½®æ–‡ä»¶æˆ–æ•°æ®åº“è¯»å–äº¤æ˜“å¯¹åˆ—è¡¨
List<String> symbols = configService.getSymbols();

// åŠ¨æ€è®¢é˜…
for (String symbol : symbols) {
    socketClient.subscribe("book." + symbol);
}
```

#### 2. è‡ªåŠ¨æ˜ å°„
```java
// ContractId æ˜ å°„è¡¨
public class ContractIdMapper {
    private static Map<String, Long> symbolToIdMap = new ConcurrentHashMap<>();
    
    static {
        symbolToIdMap.put("BTC_USDT", 1L);
        symbolToIdMap.put("ETH_USDT", 2L);
        // ... å¯ä»æ•°æ®åº“åŠ è½½
    }
    
    public static Long getContractId(String symbol) {
        return symbolToIdMap.computeIfAbsent(symbol, 
            s -> allocateNewId(s));  // åŠ¨æ€åˆ†é…
    }
}
```

#### 3. Flink State è‡ªåŠ¨æ‰©å±•
- KeyBy(contractId) å¤©ç„¶æ”¯æŒæ–°äº¤æ˜“å¯¹
- æ–° Key è‡ªåŠ¨åˆ›å»ºç‹¬ç«‹çŠ¶æ€
- æ— éœ€é‡å¯ä½œä¸š

---

### Q6.3: å¦‚ä½•æ”¯æŒå†å²æ•°æ®å›æ”¾ï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### æ–¹æ¡ˆ1ï¼šKafka æ—¶é—´å›é€€
```bash
# å°†æ¶ˆè´¹ä½ç½®é‡ç½®åˆ°æŒ‡å®šæ—¶é—´
kafka-consumer-groups.sh --reset-offsets \
  --group orderbook \
  --topic order \
  --to-datetime 2024-01-01T00:00:00.000 \
  --execute
```

#### æ–¹æ¡ˆ2ï¼šä»æ–‡ä»¶è¯»å–
```java
// æ›¿æ¢ Kafka Source ä¸ºæ–‡ä»¶ Source
StreamExecutionEnvironment see = ...;
DataStream<Order> stream = see.readTextFile("hdfs://orders.log")
    .map(line -> JSON.parseObject(line, Order.class));
```

#### æ–¹æ¡ˆ3ï¼šSavePoint + æ—¶é—´å›é€€
```bash
# 1. ä» SavePoint æ¢å¤
flink run -s hdfs://savepoints/savepoint-123 my-job.jar

# 2. Kafka Offset é‡ç½®
kafka-consumer-groups.sh --reset-offsets ...
```

---

## 7. å®æˆ˜åœºæ™¯é¢˜

### Q7.1: å‡è®¾è®¢å•ç°¿çªç„¶ä¸æ›´æ–°äº†ï¼Œå¦‚ä½•æ’æŸ¥ï¼Ÿ
**æ’æŸ¥æµç¨‹**ï¼š

#### Step 1: ç¡®è®¤ç°è±¡
```bash
# æŸ¥çœ‹ Redis æœ€æ–°æ•°æ®çš„æ—¶é—´æˆ³
redis-cli
> GET orderbook:1:1
> # æ£€æŸ¥ timestamp å­—æ®µ
```

#### Step 2: æ£€æŸ¥ Flink ä½œä¸šçŠ¶æ€
```bash
# è®¿é—® Flink Web UI (http://localhost:8081)
# æ£€æŸ¥ OrderbookJob æ˜¯å¦ RUNNING
```

#### Step 3: æ£€æŸ¥æ—¥å¿—
```bash
# TaskManager æ—¥å¿—
tail -f /usr/local/flink/log/flink-*-taskexecutor-*.log

# æŸ¥æ‰¾å¼‚å¸¸æ ˆ
grep "ERROR" flink-*-taskexecutor-*.log
```

#### Step 4: æ£€æŸ¥ Kafka æ¶ˆè´¹
```bash
# æŸ¥çœ‹æ¶ˆè´¹ Lag
kafka-consumer-groups.sh --describe --group orderbook

# å¦‚æœ Lag ä¸º 0ï¼Œè¯´æ˜æ²¡æœ‰æ–°æ•°æ®
# å¦‚æœ Lag å¾ˆå¤§ï¼Œè¯´æ˜æ¶ˆè´¹é˜»å¡
```

#### Step 5: æ£€æŸ¥ market-outer
```bash
# æŸ¥çœ‹ market-outer æ—¥å¿—
tail -f /path/to/market-outer.log

# æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€
# æ£€æŸ¥æ˜¯å¦æ­£å¸¸å†™å…¥ Kafka
```

#### Step 6: æ£€æŸ¥ä¾èµ–æœåŠ¡
```bash
# Redis
redis-cli PING

# Kafka
kafka-broker-api-versions.sh --bootstrap-server localhost:9092

# Zookeeper
echo stat | nc localhost 2181
```

**å¸¸è§åŸå› **ï¼š
1. Flink ä½œä¸š Checkpoint è¶…æ—¶é‡å¯
2. Kafka è¿æ¥æ–­å¼€
3. WebSocket æ–­çº¿æœªé‡è¿
4. Redis å†™å…¥å¤±è´¥ï¼ˆç£ç›˜æ»¡ï¼‰
5. ç½‘ç»œåˆ†åŒº

---

### Q7.2: å¦‚æœè¦æå‡10å€ååé‡ï¼Œå¦‚ä½•æ”¹é€ ï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### 1. æ¶æ„å±‚é¢
- **å¢åŠ  Kafka åˆ†åŒº**ï¼š16 â†’ 160
- **å¢åŠ  Flink å¹¶è¡Œåº¦**ï¼š1 â†’ 32
- **å¢åŠ  TaskManager**ï¼š1 â†’ 8 å°æœåŠ¡å™¨

#### 2. ä»£ç å±‚é¢
```java
// å¼‚æ­¥ Redis å†™å…¥
AsyncDataStream.unorderedWait(
    stream,
    new AsyncRedisFunction(),
    1000,  // è¶…æ—¶æ—¶é—´
    TimeUnit.MILLISECONDS,
    100    // å¼‚æ­¥è¯·æ±‚å®¹é‡
);
```

#### 3. çŠ¶æ€å­˜å‚¨
- RocksDB é…ç½®ä¼˜åŒ–ï¼š
```java
RocksDBOptionsFactory factory = new RocksDBOptionsFactory() {
    @Override
    public DBOptions createDBOptions(DBOptions currentOptions) {
        return currentOptions
            .setIncreaseParallelism(4)
            .setMaxBackgroundJobs(4);
    }
    
    @Override
    public ColumnFamilyOptions createColumnOptions(ColumnFamilyOptions currentOptions) {
        return currentOptions
            .setCompactionStyle(CompactionStyle.LEVEL)
            .setWriteBufferSize(64 * 1024 * 1024);  // 64MB
    }
};
see.setStateBackend(new RocksDBStateBackend("hdfs://...", true));
```

#### 4. ç½‘ç»œä¼˜åŒ–
```java
see.getConfig().setNetworkBufferTimeout(10);  // 10ms å¿«é€Ÿåˆ·æ–°
```

#### 5. æ•°æ®ä¼˜åŒ–
- è®¢å•åˆå¹¶ï¼šç›¸åŒä»·æ ¼çš„è®¢å•æ‰¹é‡å¤„ç†
- å®šæ—¶å™¨ä¼˜åŒ–ï¼š1ç§’ â†’ 100ms
- å¢é‡æ›´æ–°ï¼šåªå‘é€å˜åŒ–çš„ä»·æ ¼æ¡£ä½

**é¢„æœŸæå‡**ï¼š
- å•æœº 1ä¸‡ TPS â†’ åˆ†å¸ƒå¼é›†ç¾¤ 10ä¸‡ TPS

---

### Q7.3: å¦‚æœè¦ä¿è¯è®¢å•ç°¿100%å‡†ç¡®ï¼Œå¦‚ä½•è®¾è®¡ï¼Ÿ
**ç­”æ¡ˆ**ï¼š

#### 1. æ•°æ®æºä¾§
- WebSocket å¿ƒè·³ä¿æ´»ï¼Œæ–­çº¿ç«‹å³é‡è¿
- å¢åŠ è®¢å•åºåˆ—å·æ ¡éªŒï¼Œæ£€æµ‹ä¸¢å¤±
```java
if (order.getSeqId() != lastSeqId + 1) {
    log.error("Missing orders: {} to {}", lastSeqId + 1, order.getSeqId() - 1);
    // è§¦å‘å…¨é‡åŒæ­¥
    requestFullSnapshot();
}
```

#### 2. ä¼ è¾“ä¾§
- Kafka é…ç½® `acks=all`ï¼Œä¿è¯ä¸ä¸¢æ¶ˆæ¯
- Flink é…ç½® Exactly-Once è¯­ä¹‰
- Redis æŒä¹…åŒ–ï¼ˆAOF æ¨¡å¼ï¼‰

#### 3. è®¡ç®—ä¾§
```java
// å¢åŠ éªŒè¯é€»è¾‘
@Override
public void onTimer(...) {
    OrderBook orderBook = buildOrderBook();
    
    // æ ¡éªŒè®¢å•ç°¿åˆæ³•æ€§
    if (!validateOrderBook(orderBook)) {
        log.error("Invalid orderbook: {}", orderBook);
        // è§¦å‘å‘Šè­¦
        alertService.send("OrderBook validation failed");
        // ä¸è¾“å‡ºé”™è¯¯æ•°æ®
        return;
    }
    
    out.collect(orderBook);
}

private boolean validateOrderBook(OrderBook book) {
    // 1. ä¹°ç›˜æœ€é«˜ä»· < å–ç›˜æœ€ä½ä»·
    BigDecimal bestBid = book.getBids().keySet().stream().max(Comparator.naturalOrder()).orElse(BigDecimal.ZERO);
    BigDecimal bestAsk = book.getAsks().keySet().stream().min(Comparator.naturalOrder()).orElse(BigDecimal.ZERO);
    if (bestBid.compareTo(bestAsk) >= 0) {
        return false;
    }
    
    // 2. æ‰€æœ‰æ•°é‡ > 0
    for (BigDecimal qty : book.getBids().values()) {
        if (qty.compareTo(BigDecimal.ZERO) <= 0) {
            return false;
        }
    }
    
    return true;
}
```

#### 4. å¯¹è´¦æœºåˆ¶
```java
// å®šæ—¶å…¨é‡å¯¹è´¦
@Scheduled(cron = "0 0 * * * ?")  // æ¯å°æ—¶
public void reconcile() {
    // ä»äº¤æ˜“æ‰€ API è·å–å…¨é‡è®¢å•ç°¿
    OrderBook fullSnapshot = exchangeApi.getFullOrderBook(contractId);
    
    // å¯¹æ¯” Redis ä¸­çš„æ•°æ®
    OrderBook cachedBook = redisClient.get("orderbook:1:1");
    
    if (!fullSnapshot.equals(cachedBook)) {
        log.error("OrderBook mismatch, triggering full sync");
        // å…¨é‡åŒæ­¥
        redisClient.set("orderbook:1:1", fullSnapshot);
    }
}
```

---

## 8. è¡Œä¸ºé¢è¯•é—®é¢˜

### Q8.1: å›¢é˜Ÿåˆä½œä¸­é‡åˆ°åˆ†æ­§æ€ä¹ˆåŠï¼Ÿ
**STAR å›ç­”**ï¼š
- **Situation**ï¼šå¼€å‘ OrderbookJob æ—¶ï¼Œå›¢é˜Ÿå¯¹ä»·æ ¼åˆ†ç»„ç®—æ³•çš„å®ç°æœ‰åˆ†æ­§ã€‚
- **Task**ï¼šéœ€è¦åœ¨ä¿è¯ç²¾åº¦å’Œæ€§èƒ½ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚
- **Action**ï¼š
  1. ç»„ç»‡æŠ€æœ¯è®¨è®ºä¼šï¼Œåˆ—å‡ºå„æ–¹æ¡ˆä¼˜ç¼ºç‚¹
  2. æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œå¯¹æ¯”ä¸åŒæ–¹æ¡ˆçš„æ€§èƒ½æ•°æ®
  3. æœ€ç»ˆé‡‡ç”¨åŠ¨æ€ resolution æ–¹æ¡ˆï¼Œæ—¢ä¿è¯ç²¾åº¦åˆæ§åˆ¶çŠ¶æ€å¤§å°
  4. å½¢æˆæŠ€æœ¯æ–‡æ¡£ï¼Œè¾¾æˆå…±è¯†
- **Result**ï¼šæ–¹æ¡ˆä¸Šçº¿åè¿è¡Œç¨³å®šï¼Œå›¢é˜Ÿè®¤å¯

---

### Q8.2: å¦‚ä½•å­¦ä¹ æ–°æŠ€æœ¯ï¼Ÿ
**ç­”æ¡ˆï¼ˆä»¥ Flink ä¸ºä¾‹ï¼‰**ï¼š
1. **å®˜æ–¹æ–‡æ¡£**ï¼šé˜…è¯» Flink å®˜æ–¹æ–‡æ¡£ï¼Œç†è§£æ ¸å¿ƒæ¦‚å¿µ
2. **åŠ¨æ‰‹å®è·µ**ï¼šæ­å»ºæœ¬åœ°ç¯å¢ƒï¼Œè¿è¡Œç¤ºä¾‹ç¨‹åº
3. **æºç é˜…è¯»**ï¼šç ”ç©¶å…³é”®ç±»ï¼ˆå¦‚ KeyedProcessFunctionï¼‰çš„å®ç°
4. **ç¤¾åŒºäº¤æµ**ï¼šå‚åŠ æŠ€æœ¯è®ºå›ï¼ˆå¦‚ Apache Flink ä¸­æ–‡ç¤¾åŒºï¼‰
5. **å®æˆ˜é¡¹ç›®**ï¼šåœ¨ Tampines é¡¹ç›®ä¸­åº”ç”¨ï¼Œè§£å†³å®é™…é—®é¢˜
6. **æ€»ç»“è¾“å‡º**ï¼šå†™æŠ€æœ¯åšå®¢ï¼ŒåŠ æ·±ç†è§£

---

### Q8.3: ä½ çš„èŒä¸šè§„åˆ’æ˜¯ä»€ä¹ˆï¼Ÿ
**ç­”æ¡ˆç¤ºä¾‹**ï¼š
> çŸ­æœŸï¼ˆ1-2å¹´ï¼‰ï¼šæ·±è€•å®æ—¶è®¡ç®—é¢†åŸŸï¼Œæˆä¸º Flink æŠ€æœ¯ä¸“å®¶ï¼Œèƒ½å¤Ÿç‹¬ç«‹è®¾è®¡å’Œä¼˜åŒ–å¤§è§„æ¨¡æµå¤„ç†ç³»ç»Ÿã€‚
>
> ä¸­æœŸï¼ˆ3-5å¹´ï¼‰ï¼šæ‹“å±•åˆ°å¤§æ•°æ®æ¶æ„é¢†åŸŸï¼ŒæŒæ¡æ•°æ®ä»“åº“ã€æ•°æ®æ¹–ã€OLAP ç­‰æŠ€æœ¯ï¼Œæˆä¸ºæŠ€æœ¯ Leaderã€‚
>
> é•¿æœŸï¼ˆ5å¹´+ï¼‰ï¼šå‘æ¶æ„å¸ˆæˆ–æŠ€æœ¯ç®¡ç†æ–¹å‘å‘å±•ï¼Œèƒ½å¤Ÿè§„åˆ’æ•´ä¸ªå…¬å¸çš„æ•°æ®å¹³å°æ¶æ„ã€‚

---

## 9. å¿«é€Ÿå¤ä¹ æ¸…å•

### âœ… å¿…èƒŒçŸ¥è¯†ç‚¹
- [ ] é¡¹ç›®èƒŒæ™¯å’Œä¸šåŠ¡ä»·å€¼
- [ ] ä¸‰å±‚æ¶æ„è®¾è®¡
- [ ] OrderBookProcessor æ ¸å¿ƒé€»è¾‘
- [ ] Flink State ç±»å‹å’Œä½¿ç”¨
- [ ] Checkpoint æœºåˆ¶
- [ ] Exactly-Once è¯­ä¹‰å®ç°
- [ ] æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼ˆ5ä¸ªä»¥ä¸Šï¼‰
- [ ] æ•…éšœæ’æŸ¥æµç¨‹

### âœ… é«˜é¢‘é—®é¢˜ï¼ˆé‡ç‚¹å‡†å¤‡ï¼‰
1. ä»‹ç»é¡¹ç›®
2. ä¸ºä»€ä¹ˆé€‰æ‹© Flink
3. è®¢å•ç°¿å¦‚ä½•ç»´æŠ¤
4. å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§
5. é‡åˆ°çš„æŠ€æœ¯æŒ‘æˆ˜
6. æ€§èƒ½ä¼˜åŒ–æ–¹æ³•
7. æ•…éšœå¤„ç†ç»éªŒ

### âœ… æ•°æ®æŒ‡æ ‡ï¼ˆå»ºè®®è®°ä½ï¼‰
- Flink ç‰ˆæœ¬ï¼š1.17.2
- Kafka ç‰ˆæœ¬ï¼š3.1.2
- Java ç‰ˆæœ¬ï¼š1.8
- å¹¶è¡Œåº¦ï¼š1ï¼ˆå¯æ‰©å±•åˆ° 32+ï¼‰
- Checkpoint é—´éš”ï¼š60 ç§’
- è®¢å•ç°¿ç²¾åº¦ï¼š1/5/10/100
- çª—å£å¤§å°ï¼š24 å°æ—¶æ»‘åŠ¨çª—å£

---

**ç¥ä½ é¢è¯•æˆåŠŸï¼ğŸ’ª**
