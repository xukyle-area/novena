## ä¸€ã€ç»“è®º

| è®¡ç®—å¯¹è±¡                  | æ˜¯å¦å¿…é¡»ä¸²è¡Œ | å¹¶è¡Œç»´åº¦            | åŸå›                |
| ------------------------- | ------------ | ------------------- | ------------------ |
| **è®¢å•ç°¿ï¼ˆOrder Bookï¼‰**  | å¿…é¡»ä¸²è¡Œ     | symbol çº§åˆ«å¹¶è¡Œ     | å¼ºé¡ºåº + å¼ºçŠ¶æ€    |
| **Tickerï¼ˆæœ€æ–°ä»·/ç»Ÿè®¡ï¼‰** | å¯å¹¶è¡Œ       | symbol çº§åˆ«å¹¶è¡Œ     | å¯ä»æˆäº¤æµç‹¬ç«‹è®¡ç®— |
| **Candleï¼ˆKçº¿ï¼‰**         | å¯å¹¶è¡Œ       | symbol Ã— resolution | çª—å£è®¡ç®—           |
| **Depth Snapshot æ´¾ç”Ÿ**   | åŠä¸²è¡Œ       | symbol å†…ä¸²è¡Œ       | ä¾èµ–è®¢å•ç°¿çŠ¶æ€     |

ä¸€å¥è¯è®°å¿†ç‰ˆï¼š

> **è®¢å•ç°¿æ˜¯â€œçŠ¶æ€æœºâ€ï¼Œå¿…é¡»ä¸²ï¼›
> Kçº¿å’Œ Ticker æ˜¯â€œèšåˆâ€ï¼Œå¤©ç„¶å¹¶è¡Œã€‚**

---

## äºŒã€Orderbook

### 1ï¸âƒ£ è®¢å•ç°¿æ˜¯ä¸€ä¸ª**ä¸å¯äº¤æ¢çš„çŠ¶æ€æœº**

è®¢å•ç°¿æ›´æ–°äº‹ä»¶æ˜¯ï¼š

```text
ADD â†’ MODIFY â†’ MATCH â†’ CANCEL
```

è¿™äº›æ“ä½œï¼š

* **ä¸¥æ ¼ä¾èµ–é¡ºåº**
* **ä¸èƒ½ä¹±åº**
* **ä¸èƒ½å¹¶å‘ apply**

ä¸¾ä¾‹ï¼š

```text
E1: add bid 100@10
E2: cancel bid 100@10
```

E2 åœ¨ E1 ä¹‹å‰æ‰§è¡Œï¼Œç›´æ¥é”™ã€‚

---

### 2ï¸âƒ£ Flink ä¸­çš„æ­£ç¡®å§¿åŠ¿

```java
keyBy(symbol)
.process(OrderBookProcessFunction)
```

å«ä¹‰æ˜¯ï¼š

* **ä¸€ä¸ª symbol â†’ ä¸€ä¸ªå¹¶è¡Œ slot**
* slot å†…äº‹ä»¶ **ä¸¥æ ¼é¡ºåºå¤„ç†**
* ä¸åŒ symbol å®Œå…¨å¹¶è¡Œ

ğŸ‘‰ **â€œå¿…é¡»ä¸²è¡Œâ€â‰  æ•´ä¸ª Flink ä¸²è¡Œ**

---

### 3ï¸âƒ£ åƒä¸‡åˆ«åšçš„äº‹ï¼ˆçœŸå®è¸©å‘ï¼‰

âŒ ç”¨ `window` ç®—è®¢å•ç°¿
âŒ ç”¨ `async` æ›´æ–°è®¢å•ç°¿
âŒ ä¸€ä¸ª symbol æ‹†å¤šä¸ª task ç»´æŠ¤ partial book

è¿™äº›éƒ½ä¼šåœ¨é«˜é¢‘ä¸‹å‡ºâ€œå¹½çµå•â€ã€‚

---

## ä¸‰ã€Ticker

### Ticker æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

é€šå¸¸åŒ…æ‹¬ï¼š

* last price
* 24h volume
* 24h high / low
* price change %

å®ƒçš„è¾“å…¥é€šå¸¸æ˜¯ï¼š

```text
trade stream
```

è€Œä¸æ˜¯ï¼š

```text
order book mutation
```

---

### å…³é”®ç‚¹ï¼šTicker **ä¸ä¾èµ–é¡ºåºä¸€è‡´æ€§**

ä½ å…³å¿ƒçš„æ˜¯ï¼š

* æ‰€æœ‰æˆäº¤éƒ½ç®—è¿›å»
* æ—¶é—´çª—å£æ­£ç¡®

**æˆäº¤çš„é¡ºåºå¯¹ç»Ÿè®¡ç»“æœä¸æ•æ„Ÿ**ï¼ˆçª—å£å†…ï¼‰

æ‰€ä»¥ï¼š

```java
tradeStream
  .keyBy(symbol)
  .window(Sliding / Tumbling)
  .aggregate(...)
```

å¤©ç„¶å¹¶è¡Œã€‚

---

## å››ã€Candle

### 1ï¸âƒ£ Kçº¿æœ¬è´¨ = çª—å£èšåˆ

```text
open / high / low / close / volume
```

åªè¦æ»¡è¶³ï¼š

* æ—¶é—´æˆ³æ­£ç¡®
* watermark åˆç†

---

### 2ï¸âƒ£ å¹¶è¡Œç»´åº¦ç”šè‡³æ›´å¤š

```text
symbol Ã— resolution
```

ä½ å®Œå…¨å¯ä»¥ï¼š

* 1s K
* 1m K
* 5m K

åœ¨åŒä¸€ä¸ª job é‡Œå¹¶è¡Œè·‘ï¼Œç”šè‡³æ‹† jobã€‚

---

### 3ï¸âƒ£ é¡ºåºä¸é‡è¦ï¼Œæ—¶é—´é‡è¦

è¿™ç‚¹å¾ˆå…³é”®ï¼š

> **Kçº¿å…³å¿ƒæ—¶é—´ï¼Œä¸å…³å¿ƒäº‹ä»¶åˆ°è¾¾é¡ºåº**

åªè¦ watermark OKï¼Œå°±æ²¡é—®é¢˜ã€‚

---

## äº”ã€æ¨èçš„ Flink Job æ‹†åˆ†æ–¹æ¡ˆï¼ˆå®æˆ˜ï¼‰

### æ–¹æ¡ˆ Aï¼šå• Jobï¼Œå¤šç®—å­ï¼ˆå¸¸è§ï¼‰

```text
Kafka
  â†“
keyBy(symbol)
  â”œâ”€ OrderBook Operatorï¼ˆä¸²è¡Œï¼‰
  â”‚     â””â”€ emit depth
  â”œâ”€ Trade Stream
  â”‚     â””â”€ Ticker
  â”‚     â””â”€ Candle
```

ä¼˜ç‚¹ï¼š

* å»¶è¿Ÿä½
* çŠ¶æ€ä¸€è‡´

ç¼ºç‚¹ï¼š

* job è¾ƒé‡

---

### æ–¹æ¡ˆ Bï¼šå¤š Jobï¼ˆæ›´ç¨³ï¼‰

```text
Job 1: OrderBook
  Kafka â†’ keyBy(symbol) â†’ order book â†’ depth topic

Job 2: Trade Analytics
  trade topic â†’ ticker / candle

Job 3: Push Oriented
  consume derived topics
```

ä¼˜ç‚¹ï¼š

* è§£è€¦
* æ˜“æ‰©å±•
* æ˜“é‡ç®—

è¿™æ˜¯ **CEX æ›´åå¥½çš„æ–¹å¼**ã€‚

---

## ä¸ƒã€Checkpoint & Exactly-onceï¼ˆä¸èƒ½å¿½ç•¥ï¼‰

### è®¢å•ç°¿ç±» state

* RocksDB state backend
* checkpoint é—´éš” < 1sï¼ˆé«˜é¢‘ï¼‰

### Kçº¿ / Ticker

* å®¹å¿ at-least-once
* æˆ–å¹‚ç­‰å†™å…¥

---

## å…«ã€æ€»ç»“

> **Flink é‡Œä¸æ˜¯â€œç®—å­èƒ½ä¸èƒ½å¹¶è¡Œâ€ï¼Œ
> è€Œæ˜¯â€œçŠ¶æ€æ˜¯å¦å…è®¸å¹¶è¡Œâ€ã€‚**

* **è®¢å•ç°¿ï¼šçŠ¶æ€æœº â†’ å¿…é¡»ä¸²è¡Œï¼ˆsymbol å†…ï¼‰**
* **Ticker / Candleï¼šèšåˆ â†’ å¤©ç„¶å¹¶è¡Œ**
* **Depthï¼šä¾é™„è®¢å•ç°¿ï¼Œä¸ç‹¬ç«‹**

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š

* ç»™ä½ ç”»ä¸€å¼  **symbol çº§å¹¶è¡Œåº¦ç¤ºæ„å›¾**
* æˆ–å†™ä¸€ç‰ˆ **OrderBook ProcessFunction çŠ¶æ€è®¾è®¡**
* æˆ–å¸®ä½ è®¾è®¡ **Kafka topic â†’ Flink job çš„æ‹†åˆ†ç­–ç•¥**

ä½ æ›´æƒ³ç»§ç»­å“ªä¸€å—ï¼Ÿ
