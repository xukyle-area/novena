# MQTT vs WebSocket：交易所行情推送技术选型

## 核心结论

> **在大规模行情推送场景下，MQTT 比 WebSocket 更适合做推送协议层**
> 
> **内部系统：MQTT（效率与一致性优先）**  
> **对外接口：WebSocket（接入成本与兼容性优先）**

典型架构模式：
- **内部：** MQTT 作为推送层
- **对外：** WebSocket / MQTT 双协议支持
- **混合：** MQTT inside，WebSocket outside

------

## 一、协议对比

| 维度     | WebSocket       | MQTT           |
| -------- | --------------- | -------------- |
| 本质     | 双向 TCP 长连接 | 发布-订阅协议  |
| 协议层级 | HTTP Upgrade    | 独立应用层协议 |
| 通信模型 | 点对点          | Pub/Sub        |
| QoS      | ❌               | ✔（0/1/2）     |
| 会话语义 | 无              | 有             |
| 主题订阅 | 业务自己实现    | 协议原生支持   |

**核心差异：**
- **WebSocket** = 双向通信管道
- **MQTT** = 带语义的消息系统

------

## 二、行情推送的核心需求

从实际业务场景出发：

1. **一对多广播：** 一条行情 → N 个客户端
2. **精确订阅：** 按 symbol / channel 订阅
3. **高可用性：** 客户端频繁断线重连
4. **轻量状态：** 服务器状态尽量少
5. **高扩展性：** 支持高 fan-out
6. **高性能：** 低延迟 + 高吞吐

------

## 三、WebSocket 的三大局限

### 1️⃣ 缺少订阅语义

WebSocket 需要自己实现订阅机制：

```json
{
  "op": "subscribe",
  "channel": "kline",
  "symbol": "BTCUSDT"
}
```

服务端必须维护：

```text
connection → symbols → channels
```

**问题：**
- 订阅关系成为服务器内存状态
- 服务重启即丢失
- 水平扩容困难
- 跨节点同步复杂

------

### 2️⃣ Fan-out 成本高

一条行情推送的实现：

```text
行情 → for (conn in connections) send()
```

需要自行解决：
- 慢客户端处理
- 背压（Backpressure）
- Buffer 膨胀
- OOM 风险

**本质矛盾：**
- WebSocket 是 **"我推给你"** 模型
- 行情系统是 **"你来订我"** 模型

------

### 3️⃣ 断线重连不友好

客户端断线后：
- 需要重新建立连接
- 需要重新发送订阅
- 中间消息全部丢失

要实现可靠性需要自行开发：
- seq（序列号）
- ack（确认机制）
- 补发逻辑

------

## 四、MQTT 的四大优势

### 1️⃣ 原生 Pub/Sub（最关键）

Topic 模式天然适配行情订阅：

```text
market/BTCUSDT/trade
market/BTCUSDT/kline/1s
market/ETHUSDT/depth
```

客户端订阅：

```text
SUBSCRIBE market/BTCUSDT/#
```

**核心价值：服务端不关心客户端身份，只关心 Topic**

------

### 2️⃣ QoS 机制

| QoS  | 含义     | 行情用途          |
| ---- | -------- | ----------------- |
| 0    | 最多一次 | tick / 盘口深度   |
| 1    | 至少一次 | 成交记录          |
| 2    | 仅一次   | 关键业务（较少用）|

**优势：可按数据类型区分可靠性级别**

------

### 3️⃣ 会话保持

MQTT 支持持久会话：

- `clean session = false`
- 客户端断线时 broker 缓存消息
- 重连后自动继续推送

**对弱网环境的客户端是巨大优势**

------

### 4️⃣ Broker 天然支持背压

慢客户端处理：
- Broker 自动缓存
- 超限直接踢出

**不会拖垮 Push Server**

------

## 五、为什么不是所有场景都用 MQTT

### MQTT 的代价

1. **额外组件：** 需要部署和维护 MQTT Broker
2. **Topic 设计：** 必须非常严谨，否则难以维护
3. **调试成本：** 不如 WebSocket 直观
4. **浏览器支持：** 需要 websocket-mqtt 桥接

**MQTT 不是银弹，要根据场景选择**

------

## 六、内部 vs 对外的选型差异

### 内部系统：为什么选 MQTT

**前提条件：**
- 客户端可控（自己人）
- SDK 可控
- 网络环境可控
- 可以强约束接入方式

**MQTT 的价值：**

| 特性       | 内部价值                  |
| ---------- | ------------------------- |
| Pub/Sub    | 与 Kafka / Flink 心智一致 |
| Topic 设计 | 可强约束、可治理          |
| QoS        | 可按数据级别区分          |
| 会话保持   | 断线自动恢复              |
| Broker     | 扛 fan-out / 背压         |

> **内部用 MQTT，是为了"把复杂度交给成熟系统"**

------

### 对外接口：为什么选 WebSocket

**真实约束：**

对外服务的对象：
- 量化团队
- 其他交易所
- 金融机构
- 各种语言 / 各种环境

**WebSocket 的优势：**

| 维度       | WebSocket     |
| ---------- | ------------- |
| 浏览器支持 | 原生          |
| SDK 成本   | 几乎为 0      |
| 防火墙     | 容易放行      |
| 学习成本   | 极低          |
| 运维成本   | 不需要 broker |

> **对外接口，第一原则是"好接入"，而不是"最优雅"**

------

### 关键区别：对外 ≠ 高 fan-out

对外企业推送的特点：

| 特征         | 值   |
| ------------ | ---- |
| 连接数       | 少   |
| 每连接订阅数 | 多   |
| 客户端能力   | 强   |
| 接入稳定性   | 高   |

**结论：**
- 不需要 broker 扛百万连接
- 不需要 QoS
- 不需要 session

WebSocket 完全够用，甚至更清晰。

------

## 七、实际架构模式

### 混合架构（主流方案）

```
Kafka → 内部 MQTT Broker
              ↓
       WebSocket Gateway
              ↓
       企业 / 量化客户
```

**架构特点：**
- 内部统一使用 MQTT
- 对外用 WebSocket 做**协议适配层**
- Gateway 本身是**无状态或轻状态**

------

### 为什么不直接对外 MQTT

现实原因：

1. **企业网络策略：** 很多企业网络不允许 MQTT 协议
2. **浏览器支持：** 需要额外的桥接层
3. **Topic 治理：** 对外开放容易失控
4. **误用风险：** 客户误用 QoS 导致 broker 压力
5. **安全模型：** 更复杂，责任边界不清

**交易所不想为这些问题背锅**

------

## 八、总结

### 核心思维

> **内部：追求系统整体效率与一致性**  
> **外部：追求接入成本与生态友好**

这是**成熟系统设计**的思维，而不是"技术选型洁癖"。

### 一句话精华

> **MQTT 是工程内功，WebSocket 是生态妥协。**  
> **内部选最省事的，对外选最不折腾别人的。**

### 选型决策表

| 场景             | 推荐方案   | 关键因素                     |
| ---------------- | ---------- | ---------------------------- |
| 内部行情推送     | MQTT       | Pub/Sub、QoS、会话保持       |
| 对外企业接口     | WebSocket  | 兼容性、接入成本、运维简单   |
| C 端大规模推送   | MQTT       | 百万连接、弱网、高 fan-out   |
| 管理后台实时通知 | WebSocket  | 连接少、双向通信             |
| 混合架构         | 两者都用   | 内部 MQTT，外部 WS 做适配层  |
