# OTC 订单和结算状态梳理文档

## 一、系统概述

OTC（场外交易）系统中的订单生命周期涉及三个主要的状态维度：
1. **订单状态（OtcOrderStatus）** - 用户订单的整体状态
2. **LP订单状态（OtcLpOrderStatus）** - 向流动性提供商（LP）发送的订单状态
3. **结算状态（OtcSettleStatus）** - 订单成交后的结算状态

---

## 二、订单状态（OtcOrderStatus）

### 2.1 状态定义

| 状态值 | 英文名称        | 中文描述 | 备注                                              |
| ------ | --------------- | -------- | ------------------------------------------------- |
| 1      | PENDING_NEW     | 待下单   | 用户提交订单，资产已锁定，待向LP发送订单          |
| 2      | NEW             | 已下单   | 订单已发送给LP，等待LP反馈                        |
| 3      | CONFIRMED       | 已确认   | LP已成交，订单成交确认（此时LP订单状态为FILLED）  |
| 4      | PENDING_FAILED  | 待失败   | pre-trade检查阶段失败，但未正式置为失败状态       |
| 5      | FAILED          | 已失败   | pre-trade检查失败，订单下单失败，用户资产已解锁   |
| 6      | PENDING_CANCEL  | 待取消   | 用户发起取消，或LP拒绝了订单                      |
| 7      | CANCELED        | 已取消   | 订单已取消，用户资产已解锁                        |
| 8      | PARTIAL_FILLED  | 部分成交 | LP部分成交（未实现，保留状态）                    |
| 9      | FILLED          | 全部成交 | 订单完全成交（目前系统中不使用，用CONFIRMED代替） |
| 10     | PARTIAL_SETTLED | 部分结算 | 订单的部分成交金额已结算                          |
| 11     | SETTLED         | 全部结算 | 订单的全部成交金额已结算                          |

### 2.2 状态转换流程图

```
┌─────────────┐
│ PENDING_NEW │  (User Submits Order)
└──────┬──────┘
       │
       ├─ [Asset Lock Failed] ─────────────────────────┐
       │                                               │
       ├─ [Pre-Trade Check Failed] ────────────────────┤
       │                                               │
       ├─ [Asset Lock Successful]                      │
       ↓                                               │
┌─────────────┐                                        │
│   NEW       │  (Sent to LP)                          │
└──────┬──────┘                                        │
       │                                               │
       ├─ [LP Rejected/Timeout] ──┐                    │
       │                          │                    │
       ├─ [LP Traded] ────────────┤                    │
       ↓                          │                    │
┌──────────────┐                  │                    │
│  CONFIRMED   │                  │                    │
└──────┬───────┘                  │                    │
       │                          │                    │
       ├─ [Settlement] ─┐         │                    │
       │                │         │                    │
       ↓                ↓         │                    │
   SETTLED   PENDING_CANCEL       │                    │
           (PARTIAL_SETTLED)      │                    │
                                  │                    │
                                  │                    │
                                  ↓                    ↓
                       ┌──────────────┐          ┌──────────────┐
                       │   CANCELED   │          │    FAILED    │
                       └──────────────┘          └──────────────┘
```

### 2.3 关键状态转换说明

#### Normal Trading Flow
1. **PENDING_NEW → NEW**: Asset locked successfully, order sent to LP
2. **NEW → CONFIRMED**: LP order filled (when LP order status changes to FILLED)
3. **CONFIRMED → PARTIAL_SETTLED / SETTLED**: Fund clearing completed through partial settlement or combination settlement

#### Failure and Cancellation Flow
1. **PENDING_NEW → FAILED**: Pre-trade check failed (insufficient assets, credit limit exceeded, etc.)
2. **PENDING_NEW → PENDING_FAILED**: Asset lock failed, status cached
3. **PENDING_FAILED → FAILED**: Status updated after failure confirmation
4. **NEW → PENDING_CANCEL**: LP rejected order or user initiated cancellation
5. **PENDING_CANCEL → CANCELED**: Order formally canceled

---

## 三、LP订单状态（OtcLpOrderStatus）

### 3.1 状态定义

| 状态值 | 英文名称    | 中文描述     | 说明                                                     |
| ------ | ----------- | ------------ | -------------------------------------------------------- |
| 1      | INIT        | 初始状态     | 订单刚创建，未向LP发送                                   |
| 2      | PENDING_NEW | 待新订单     | 订单已发送至LP，LP正在处理（对应ExecReport中PendingNew） |
| 3      | NEW         | 新订单已接收 | LP已接收订单，正在处理（对应ExecReport中New）            |
| 4      | REJECTED    | 已拒绝       | LP拒绝了此订单（对应ExecReport中Rejected）               |
| 5      | CANCELED    | 已取消       | LP发起或确认了取消（对应ExecReport中Canceled）           |
| 6      | FILLED      | 已成交       | LP订单已成交（对应ExecReport中Filled）                   |

### 3.2 LP订单状态与主订单状态的映射关系

| LP订单状态  | 主订单状态     | 描述                         |
| ----------- | -------------- | ---------------------------- |
| INIT        | PENDING_NEW    | 初始状态对应待下单           |
| PENDING_NEW | NEW            | 已发送至LP                   |
| NEW         | NEW            | 在LP处理中                   |
| REJECTED    | PENDING_CANCEL | LP拒绝订单，主订单改为待取消 |
| CANCELED    | PENDING_CANCEL | LP确认取消，主订单改为待取消 |
| FILLED      | CONFIRMED      | LP成交，主订单变为已确认     |

### 3.3 状态转换流程（ExecReport驱动）

```
┌──────┐
│ INIT │
└───┬──┘
    │
    ├─ [ExecReport: PendingNew] ──→ PENDING_NEW
    │                                   │
    ├─ [ExecReport: New] ──────────────→ NEW
    │                                   │
    ├─ [ExecReport: Rejected] ────────→ REJECTED
    │                    (主订单 → PENDING_CANCEL)
    │
    ├─ [ExecReport: Canceled] ───────→ CANCELED
    │                   (主订单 → PENDING_CANCEL)
    │
    └─ [ExecReport: Filled] ────────→ FILLED
                        (主订单 → CONFIRMED)
```

---

## 四、结算状态（OtcSettleStatus）

### 4.1 状态定义

| 状态值 | 英文名称        | 中文描述     | 使用场景                                     |
| ------ | --------------- | ------------ | -------------------------------------------- |
| 1      | PARTIAL_NEW     | 部分结算新建 | 对单个已成交订单发起部分结算（金额未达全额） |
| 2      | COMBINATION_NEW | 组合结算新建 | 对多个已成交订单进行组合结算（按LP组合）     |
| 3      | SUCC            | 结算成功     | 结算交易已成功完成，资金已清算               |
| 4      | FAIL            | 结算失败     | 结算过程中发生错误，资金清算失败             |

### 4.2 结算流程说明

#### 部分结算流程
```
CONFIRMED订单（包含部分成交数量）
    ↓
创建 OtcOrderSettle 记录（状态: PARTIAL_NEW）
    ↓
锁定LP资产
    ↓
执行结算操作（partialSettle方法）
    ↓
SUCC（或FAIL失败）
    ↓
更新主订单状态 → PARTIAL_SETTLED
```

#### 组合结算流程
```
多个 CONFIRMED 订单（同一LP）
    ↓
批量创建 OtcOrderSettle 记录（状态: COMBINATION_NEW）
    ↓
锁定LP资产
    ↓
执行组合结算操作（combinationSettle方法）
    ↓
SUCC（或FAIL失败）
    ↓
更新主订单状态 → SETTLED（如全额结算）或 PARTIAL_SETTLED
```

### 4.3 结算与订单状态的关系

| 订单状态        | 结算状态  | 说明                     |
| --------------- | --------- | ------------------------ |
| CONFIRMED       | 无/待结算 | 订单已成交，可以发起结算 |
| PARTIAL_SETTLED | SUCC/FAIL | 部分结算已完成           |
| SETTLED         | SUCC/FAIL | 全额结算已完成           |

---

## 五、状态数据模型

### 5.1 OtcOrder表中的相关字段

```java
public class OtcOrder {
    Long id;                      // 订单ID
    String otcStatus;             // 订单状态（OtcOrderStatus）
    String lpOrderStatus;         // LP订单状态（OtcLpOrderStatus）
    Long lpId;                    // 流动性提供商ID
    String lpOrderId;             // LP侧订单号
    String symbol;                // 交易对符号（BTC/USDT等）
    String action;                // 操作类型（BUY/SELL）
    BigDecimal filledQuantity;    // 成交数量
    BigDecimal filledAmount;      // 成交金额
    BigDecimal lpFilledQuantity;  // LP侧成交数量
    BigDecimal lpFilledAmount;    // LP侧成交金额
    BigDecimal settleQuantity;    // 已结算数量
    BigDecimal settleAmount;      // 已结算金额
    Long settleId;                // 结算分组ID（用于组合结算）
    String rejectReason;          // 拒绝/失败原因
    Date updatedAt;               // 最后更新时间
}
```

### 5.2 OtcOrderSettle表中的相关字段

```java
public class OtcOrderSettle {
    Long id;                           // 结算记录ID
    Long orderId;                      // 关联的订单ID
    String status;                     // 结算状态（OtcSettleStatus）
    BigDecimal settleAmount;           // 结算金额
    BigDecimal settleQuantity;         // 结算数量
    BigDecimal lpSettleAmount;         // LP侧结算金额
    BigDecimal markupSettleAmount;     // 标记价差（利润）
    Long settleCombinationId;          // 组合结算ID
    String operator;                   // 操作人
    Date createdAt;                    // 创建时间
    Date updatedAt;                    // 更新时间
}
```

---

## 六、状态查询和监控

### 6.1 关键查询接口

#### 按状态查询订单
```
OtcOrderDao.selectByStatus(List<OtcOrderStatus> statuses)
OtcOrderDao.selectOrdersByLpIdAndStatus(int lpId, List<String> otcOrderStatuses)
```

#### 查询结算记录
```
OtcOrderSettleDao.selectByOrderId(long orderId)
OtcOrderSettleDao.select(OtcSettleStatus status)
```

### 6.2 监控任务

| 任务名称                      | 触发条件                                       | 处理操作                             |
| ----------------------------- | ---------------------------------------------- | ------------------------------------ |
| OtcOrderProcessLockTask       | PENDING_NEW, PENDING_FAILED 状态               | 检查资产锁定，推进订单状态           |
| OtcOrderPartialSettleTask     | PARTIAL_NEW 结算状态                           | 执行部分结算操作                     |
| OtcOrderCombinationSettleTask | COMBINATION_NEW 结算状态                       | 执行组合结算操作                     |
| OtcOrderStatusCheck           | 所有订单状态                                   | 检查超过24小时未变化的订单，发送告警 |
| OtcOrderStatusCheckForSettle  | CONFIRMED, PARTIAL_FILLED, PENDING_CANCEL 状态 | 检查待处理订单，发送告警             |
| OtcOrderCancelTask            | 超时订单                                       | 自动取消超、 时未成交的订单          |

### 6.3 状态映射（前端展示）

系统提供了 `OrderStatusConverter` 用于将内部状态转换为前端展示的用户友好状态：

| 前端展示        | 内部状态                         |
| --------------- | -------------------------------- |
| Pending         | PENDING_NEW, PENDING_FAILED, NEW |
| Offer Locked    | CONFIRMED, PENDING_CANCEL        |
| Filled          | FILLED                           |
| Partial Filled  | PARTIAL_FILLED                   |
| Partial Settled | PARTIAL_SETTLED                  |
| Settled         | SETTLED                          |
| Canceled        | CANCELED                         |
| Failed          | FAILED                           |

---

## 七、异常状态处理

### 7.1 订单超时处理

订单在以下状态下超过24小时未变化时，触发告警：
- PENDING_NEW
- NEW
- CONFIRMED
- PENDING_FAILED
- PENDING_CANCEL
- FAILED
- PARTIAL_FILLED
- FILLED

### 7.2 积压订单处理

持续监控以下状态的订单数量，如有积压则发送告警：
- CONFIRMED：已确认未结算
- PARTIAL_FILLED：部分成交未完全结算
- PENDING_CANCEL：待取消未处理

### 7.3 结算异常处理

- **结算超时**: 如果结算状态为 PARTIAL_NEW 或 COMBINATION_NEW 超过预定时间，需人工介入
- **结算失败**: FAIL 状态的结算记录需要调查原因并重新处理

---

## 八、关键业务规则

### 8.1 订单创建规则
- 订单初始状态为 PENDING_NEW
- LP订单状态初始为 INIT
- 订单创建时，根据用户资产自动锁定

### 8.2 订单推进规则
- 资产锁定成功后，自动向LP发送订单（状态变为 NEW）
- LP返回成交报告（ExecReport）后，根据报告内容更新对应状态
- 不允许从 FILLED 状态重复更新（去重逻辑）

### 8.3 订单取消规则
- 只有 CONFIRMED 或 PARTIAL_FILLED 状态的订单可以被取消
- 取消会先变为 PENDING_CANCEL，等待LP确认
- LP确认后变为 CANCELED，资产解锁

### 8.4 结算规则
- 只有 CONFIRMED 或 PARTIAL_FILLED 状态的订单可以发起结算
- 不能对存在未完成结算记录（PARTIAL_NEW或COMBINATION_NEW）的订单发起新结算
- 结算金额不能超过已成交金额

---

## 九、代码参考

### 9.1 核心枚举类
- [OtcOrderStatus.java](otc-model/src/main/java/com/tiger/exodus/otc/model/enums/OtcOrderStatus.java)
- [OtcLpOrderStatus.java](otc-model/src/main/java/com/tiger/exodus/otc/model/enums/OtcLpOrderStatus.java)
- [OtcSettleStatus.java](otc-model/src/main/java/com/tiger/exodus/otc/model/enums/OtcSettleStatus.java)

### 9.2 核心服务类
- [OtcOrderService](otc-order/src/main/java/com/tiger/exodus/otc/order/service/OtcOrderService.java) - 订单业务逻辑
- [OtcOrderPartialSettleService](otc-order/src/main/java/com/tiger/exodus/otc/order/service/OtcOrderPartialSettleService.java) - 部分结算
- [OtcOrderCombinationSettleService](otc-order/src/main/java/com/tiger/exodus/otc/order/service/OtcOrderCombinationSettleService.java) - 组合结算
- [ExecReportHandler](otc-server/src/main/java/com/tiger/exodus/otc/server/service/ExecReportHandler.java) - LP成交报告处理
- [OtcOrderTask](otc-server/src/main/java/com/tiger/exodus/otc/server/task/OtcOrderTask.java) - 定时任务处理

### 9.3 DAO接口
- [OtcOrderDao](otc-model/src/main/java/com/tiger/exodus/otc/model/dao/OtcOrderDao.java)
- [OtcOrderSettleDao](otc-model/src/main/java/com/tiger/exodus/otc/model/dao/OtcOrderSettleDao.java)

---

## 十、常见问题

### Q1: 为什么订单状态有 PENDING_NEW 和 PENDING_FAILED 两个 PENDING 状态？

**A**: 
- PENDING_NEW：资产锁定成功，待向LP发送订单
- PENDING_FAILED：资产锁定失败，待最终确认为FAILED状态

这样的设计便于区分失败原因，支持重试机制。

### Q2: FILLED 和 CONFIRMED 状态的区别是什么？

**A**: 
- FILLED：仅表示LP订单已成交（历史遗留状态，目前不使用）
- CONFIRMED：表示用户订单已确认成交，所有成交信息已确认，可以进行结算

实际流程中使用 CONFIRMED 作为成交确认状态。

### Q3: 为什么需要部分结算和组合结算两种方式？

**A**: 
- **部分结算**: 用户可能只想结算部分已成交的数量（如只结算部分利润）
- **组合结算**: 系统可以对同一LP的多个订单进行组合结算，提高清算效率

### Q4: 结算状态何时变为 SUCC 或 FAIL？

**A**: 
结算操作包含锁定资产、执行清算、更新账户等多个步骤，只有所有步骤都成功时才会变为SUCC，否则为FAIL。

### Q5: 订单可以从 NEW 状态重新回到 PENDING_NEW 吗？

**A**: 
不可以。状态只能向前推进，不能回退。若订单发送至LP后失败，应该进入 PENDING_CANCEL 状态等待取消。

---

## 十一、更新日志

| 日期       | 版本 | 变更说明                                               |
| ---------- | ---- | ------------------------------------------------------ |
| 2024-02-07 | v1.0 | 初始文档版本，梳理订单、LP订单、结算三个维度的状态体系 |

---

**文档维护者**: OTC系统开发团队  
**最后更新**: 2024-02-07
