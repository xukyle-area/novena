## 结论

> **单机限流解决“单点过载”，Redis 限流解决“全局公平与风控一致性”。**
> 真正成熟的系统，**一定是两层一起用，而不是二选一。**

---

## 一、单机限流是什么？

单机限流通常是：

* 本地内存
* 原子变量 / 滑动窗口 / 令牌桶
* 不依赖网络

### 常见实现

* `Guava RateLimiter`
* `Semaphore`
* 本地 RingBuffer / 滑动窗口数组
* Netty / Envoy 内建限流

---

## 二、Redis（ZSET）限流是什么？

* 所有实例 **共享同一限流视图**
* 基于 Redis 的全局状态
* 精确控制「某用户 / 某 IP / 某 API」的整体行为

---

## 三、核心对比（重点）

### 1️⃣ 限流视角不同（这是本质差异）

| 维度   | 单机限流    | Redis ZSET 限流 |
| ---- | ------- | ------------- |
| 控制范围 | **单实例** | **全实例 / 全集群** |
| 目标   | 防止本机被打爆 | 防刷 / 公平 / 风控  |
| 视角   | 局部      | 全局            |

> 如果你有 **N 台机器**：
> 单机限流 = 实际限额 × N（隐性放大）

---

### 2️⃣ 精度与一致性

| 项目  | 单机    | Redis ZSET   |
| --- | ----- | ------------ |
| 精度  | 高     | **最高（滑动窗口）** |
| 一致性 | ❌ 不一致 | ✅ 强一致        |
| 抗抖动 | 一般    | 好            |

**例子：**

> 限制用户 1 分钟 100 次
> 5 台机器
>
> * 单机：可能 500 次
> * Redis：最多 100 次

---

### 3️⃣ 性能与成本

| 项目  | 单机      | Redis ZSET |
| --- | ------- | ---------- |
| 延迟  | 纳秒 / 微秒 | 毫秒级        |
| QPS | 极高      | 有上限        |
| 内存  | 本地      | Redis      |
| 网络  | 无       | 有          |

**所以：**

> 单机限流 = 性能兜底
> Redis 限流 = 规则兜底

---

### 4️⃣ 可靠性与故障模式

| 场景       | 单机    | Redis  |
| -------- | ----- | ------ |
| Redis 挂了 | 不受影响  | ❌ 限流失效 |
| 单实例异常    | 只影响自己 | 不影响整体  |
| 网络抖动     | 无影响   | 有影响    |

**生产必问：**

> Redis 不可用时，是「全放行」还是「全拒绝」？

这必须提前定策略。

---

## 四、什么时候**一定不能只用单机限流**？

非常关键👇

### ❌ 以下场景，只用单机是**架构性错误**

1. **按用户 / IP / API Key 限流**
2. **交易、下单、提现**
3. **风控、防刷、防爆破**
4. **计费 / 配额**
5. **合规要求“公平性”的系统**

你现在做的 **交易所 / 行情 / 风控系统**，全部命中。

---

## 五、什么时候**不该上 Redis ZSET**？

### ❌ 以下场景，上 Redis 是浪费

1. 内部 RPC
2. 服务保护（防止自己 OOM）
3. 非关键接口
4. 超高 QPS（百万级）

这里：

> **单机限流才是第一道防线**

---

## 六、生产级最佳实践（你应该用的）

### ✅ 双层限流（强烈推荐）

```text
        请求
         ↓
[ 单机限流（令牌桶） ]  ← 快、便宜
         ↓
[ Redis ZSET 限流 ]     ← 准、全局
         ↓
       业务逻辑
```

### 为什么这么做？

* 80% 的请求被挡在本机
* Redis QPS 压力大幅下降
* Redis 抖动不会瞬间拖垮业务

---

## 七、交易系统里的真实落地方式（经验）

在交易系统中，常见做法是：

| 接口   | 限流方式       |
| ---- | ---------- |
| 行情订阅 | 单机         |
| 查询接口 | 单机         |
| 登录   | Redis      |
| 下单   | Redis + 单机 |
| 撤单   | Redis + 单机 |
| 风控   | Redis（硬规则） |
